<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Claims Portal</title>
  <style>
    :root{
      --bg:#f6f7fb; --paper:#fff; --ink:#0f172a; --muted:#6b7280;
      --border:#e5e7eb; --soft:#f1f5f9; --brand:#111; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444; --wa:#25D366;
      --radius:14px; --radius-sm:10px; --shadow:0 10px 25px rgba(0,0,0,.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font:14px/1.5 system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      color:var(--ink); background:linear-gradient(180deg,#fafbff 0,#f6f7fb 100%);
    }

    /* Header + Tabs */
    header{position:sticky;top:0;background:rgba(255,255,255,.8);backdrop-filter:saturate(1.2) blur(6px);border-bottom:1px solid var(--border);z-index:20}
    .topbar{display:flex;align-items:center;gap:12px;padding:14px 18px}
    .title{font-weight:700;letter-spacing:.2px}
    .tabs{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-left:auto}
    .tab{
      padding:8px 12px;border-radius:999px;border:1px solid var(--border);background:var(--paper);
      cursor:pointer; transition:.15s; box-shadow:0 1px 0 rgba(0,0,0,.02)
    }
    .tab:hover{transform:translateY(-1px)}
    .tab.active{background:var(--ink);color:#fff;border-color:var(--ink)}
    .badge{display:inline-block;min-width:20px;height:20px;line-height:20px;padding:0 7px;border-radius:999px;background:var(--ink);color:#fff;text-align:center;font-size:12px;margin-left:8px}

    /* Filters */
    .search{padding:12px 18px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;border-top:1px solid var(--border);background:var(--paper)}
    input[type="text"], input[type="url"], input[type="tel"], select, input[type="date"], textarea{
      padding:10px 12px;border:1px solid #d1d5db;border-radius:var(--radius-sm);min-width:170px;background:#fff;outline:none;
      transition:border .15s, box-shadow .15s
    }
    input:focus, select:focus, textarea:focus{border-color:#cbd5e1; box-shadow:0 0 0 4px #e2e8f0}

    button{
      padding:10px 12px;border-radius:var(--radius-sm);border:1px solid var(--ink);background:var(--ink);color:#fff;cursor:pointer;
      transition:transform .12s, box-shadow .12s; box-shadow:0 1px 0 rgba(0,0,0,.06)
    }
    button:hover{transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.08)}
    button.secondary{background:var(--paper);color:var(--ink)}
    button[disabled]{opacity:.55;cursor:not-allowed}

    /* Layout */
    .container{display:grid;grid-template-columns:1fr;gap:16px;padding:16px}
    @media(min-width:1100px){.container{grid-template-columns:60% 40%; align-items:start}}

    .card{
      background:var(--paper); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow)
    }
    .left{padding:14px}
    .right{padding:18px; position:sticky; top:86px; height:calc(100vh - 100px); overflow:auto}

    /* Table */
    table{width:100%; border-collapse:separate; border-spacing:0; background:var(--paper); overflow:hidden; border-radius:var(--radius); border:1px solid var(--border)}
    th,td{padding:12px 12px; text-align:left; font-size:14px; vertical-align:top; border-bottom:1px solid var(--soft)}
    thead th{background:#fbfbfe; position:sticky; top:0; z-index:1}
    tbody tr:hover{background:#fafcff}
    tbody tr:nth-child(2n){background:#fcfdff}
    .chip{display:inline-block;padding:3px 9px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .chip.inprocess{background:#fff7e6;border-color:#fde68a}
    .chip.done{background:#eafff1;border-color:#86efac}
    .chip.rejected{background:#ffecec;border-color:#fecaca}
    .sla{display:inline-block;border-radius:999px;padding:2px 8px;font-size:12px;border:1px solid var(--border);margin-left:6px}
    .sla.on{background:#eafff1;border-color:#86efac}
    .sla.today{background:#fff7e6;border-color:#fde68a}
    .sla.over{background:#ffecec;border-color:#fecaca}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* WhatsApp button – white circle + green glyph (ikut gambar) */
    .wa{
      display:inline-flex; align-items:center; justify-content:center;
      width:36px;height:36px;border-radius:999px;
      background:#fff;border:1px solid var(--border); box-shadow:0 2px 8px rgba(16,24,40,.06);
      text-decoration:none
    }
    .wa:hover{box-shadow:0 6px 18px rgba(16,24,40,.12)}
    .wa .icon{width:18px;height:18px;display:block}
    /* optional subtle ring on focus */
    .wa:focus{outline:none; box-shadow:0 0 0 4px #e2fbe4}

    .muted{color:var(--muted); font-size:12px}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}

    /* Loading overlay */
    .loading{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:rgba(255,255,255,.55);backdrop-filter:saturate(1.2) blur(2px);z-index:9999}
    .loading.show{display:flex}
    .spinner{width:56px;height:56px;border-radius:50%;border:6px solid #e5e7eb;border-top-color:#111;animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title">Panel Claims Portal</div>
      <div class="tabs">
        <div class="tab active" data-tab="inprocess">Panel (In Process) <span id="badge-inprocess" class="badge">0</span></div>
        <div class="tab" data-tab="submitted">Panel (Submitted) <span id="badge-submitted" class="badge">0</span></div>
        <div class="tab" data-tab="done">Panel (Done) <span id="badge-done" class="badge">0</span></div>
        <div class="tab" data-tab="rejected">Panel (Rejected) <span id="badge-rejected" class="badge">0</span></div>
        <div class="tab" data-tab="regpanel">Reg Panel</div>
      </div>
    </div>
    <div class="search" id="searchBar">
      <input id="search" type="text" placeholder="Cari nama/IC..." />
      <select id="filterPanelSelect" title="Tapis Jenis Panel"><option value="">Semua Panel</option></select>
      <input id="filterPanelText" type="text" placeholder="Tulis nama panel..." />
      <select id="sort">
        <option value="tarikh_desc">Tarikh Hadir: Terbaru</option>
        <option value="tarikh_asc">Tarikh Hadir: Terdahulu</option>
        <option value="panel_az">Jenis Panel: A → Z</option>
        <option value="panel_za">Jenis Panel: Z → A</option>
        <option value="nama_az">Nama Pesakit: A → Z</option>
        <option value="nama_za">Nama Pesakit: Z → A</option>
      </select>
      <select id="filterSLA" title="Status SLA">
        <option value="">SLA: Semua</option>
        <option value="over">SLA: Overdue</option>
        <option value="today">SLA: Due Today</option>
        <option value="on">SLA: On Track</option>
      </select>
      <select id="pageSize" title="Rekod per halaman"><option>25</option><option selected>50</option><option>100</option></select>
      <button id="refresh" class="secondary" title="Muat semula">Refresh</button>
    </div>
  </header>

  <div class="container">
    <!-- LEFT -->
    <section class="left card">
      <div id="recordsView">
        <table>
          <thead>
            <tr>
              <th>Nama</th>
              <th>IC</th>
              <th>Telefon</th>
              <th>Tarikh Hadir</th>
              <th>Panel / PIC</th>
              <th>Harga</th>
              <th>Ubat</th>
              <th>Status</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="actions" style="margin-top:12px">
          <button id="prev" class="secondary">Prev</button>
          <span id="pageInfo" class="muted"></span>
          <button id="next" class="secondary">Next</button>
        </div>
      </div>

      <!-- REG PANEL -->
      <div id="regPanelView" style="display:none">
        <div class="card" style="margin:12px 0; padding:14px">
          <h3 style="margin:0 0 8px 0">Daftar Panel Baharu</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><label>Nama Panel *</label><input id="rp_name" type="text" placeholder="Contoh: AIA" required /></div>
            <div><label>Link Panel (URL) *</label><input id="rp_link" type="url" placeholder="https://..." required /></div>
            <div><label>Nama PIC</label><input id="rp_pic_name" type="text" placeholder="Contoh: En. Ahmad" /></div>
            <div><label>No. Telefon PIC</label><input id="rp_pic_phone" type="tel" placeholder="0123456789" /></div>
            <div><label>Tempoh (hari) *</label><input id="rp_terms_days" type="number" min="1" step="1" placeholder="cth: 30" /></div>
            <div style="grid-column:1 / -1"><label>Catatan</label><textarea id="rp_notes" placeholder="Nota tambahan jika perlu" style="width:100%"></textarea></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="rp_save">Simpan Panel</button>
            <button id="rp_clear" class="secondary">Clear</button>
          </div>
        </div>

        <div class="card" style="padding:14px">
          <h3 style="margin:0 0 8px 0">Senarai Panel Berdaftar <span class="muted">(klik Edit untuk ubah terus dalam baris)</span></h3>
          <table>
            <thead>
              <tr>
                <th>Nama</th>
                <th>Link</th>
                <th>PIC</th>
                <th>Telefon PIC</th>
                <th>Tempoh (hari)</th>
                <th>Catatan</th>
                <th>WhatsApp</th>
                <th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="rp_tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="right card">
      <h3 style="margin:4px 0 8px 0">Panel Window</h3>
      <p class="muted">Klik <b>Open</b> atau ikon <b>WhatsApp</b>. Tetingkap kanan dibuka sekali & dikitar semula (URL sama → fokus, tiada duplikasi).</p>
      <div id="detail"></div>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>
  <div id="loading" class="loading" aria-live="polite"><div class="spinner" title="Loading..."></div></div>

  <script>
  /* ================= CONFIG ================= */
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzkhLra1C5rg2HWY2oc3LlkLmBbKTtTbqThN7P0kpqC7z4b6yfMRJLXm4BBLkPzSko/exec';

  /* ================= STATE ================= */
  let state = { tab:'inprocess', page:1, pageSize:50, q:'', sort:'tarikh_desc', filterPanelSelect:'', filterPanelText:'', filterSLA:'' };
  let panelWin = null, lastOpenTs = 0;
  let regPanelMap = new Map();

  /* ================= HELPERS ================= */
  const el = s => document.querySelector(s);
  const tbody = el('#tbody');
  const pageInfo = el('#pageInfo');
  const toastEl = el('#toast');
  const loader = el('#loading');
  const escapeHtml = s => String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function toast(m){ toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2200); }
  function showLoading(){ loader.classList.add('show'); }
  function hideLoading(){ loader.classList.remove('show'); }

  // Tarikh DD/MM/YYYY HH:mm
  function formatDateDDMMYYYY_HHMM(v){
    if(!v) return '';
    let d; if(v instanceof Date) d=v; else { const s=String(v); d=/^\\d{4}-\\d{2}-\\d{2}$/.test(s)?new Date(s+'T00:00:00'):new Date(s); if(isNaN(d)) return escapeHtml(s); }
    const pad=n=>String(n).padStart(2,'0'); return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }
  const toDigits = s => String(s||'').replace(/[^\\d]/g,'');
  function buildWAUrl(phone, text){ const p=toDigits(phone); const q=encodeURIComponent(text||''); if(!p) return ''; return `https://web.whatsapp.com/send?phone=${p}${q?`&text=${q}`:''}`; }

  // Ikon WA: hanya glyph hijau (tanpa bulatan hijau)
  const waSVG = `
  <svg class="icon" viewBox="0 0 32 32" aria-hidden="true" focusable="false">
    <path fill="#25D366" d="M19.11 17.06c-.18-.1-1.04-.54-1.2-.6-.16-.06-.27-.1-.38.1-.12.2-.44.6-.54.72-.1.12-.2.14-.38.08-.18-.06-.76-.28-1.45-.89a5.23 5.23 0 0 1-1.62-2.04c-.08-.18 0-.28.07-.38.07-.1.18-.22.26-.34.09-.12.12-.2.18-.32.06-.12.03-.24 0-.34-.03-.1-.38-1.02-.52-1.41-.14-.4-.29-.33-.38-.33h-.33c-.1 0-.33.05-.5.23-.17.17-.66.64-.66 1.56 0 .92.68 1.8.78 1.92.1.12 1.34 2.05 3.25 2.89.46.2.83.33 1.12.42.47.15.9.13 1.24.08.38-.06 1.04-.43 1.19-.85.15-.42.15-.78.1-.85-.05-.07-.17-.11-.35-.2zM16 6.1c-4.47 0-8.1 3.5-8.1 7.9 0 1.56.5 3 .1 0 0 0 .5 0 0 0"/>
  </svg>`;

  /* ============== WINDOW REUSE (kanan) ============== */
  function openOrReusePanel(url){
    if(!url) return;
    const now=Date.now(); if(now-lastOpenTs<250) return; lastOpenTs=now;
    try{
      if(panelWin && !panelWin.closed){
        try{ const current=panelWin.location && String(panelWin.location.href); if(current===String(url)){ panelWin.focus(); return; } }catch(e){}
        panelWin.location.href=url; panelWin.focus(); return;
      }
    }catch(e){}
    const sw=window.screen.availWidth, sh=window.screen.availHeight;
    const w=Math.max(520, Math.round(sw*0.36)), h=Math.max(650, sh);
    const left=Math.max(0, sw-w), top=0;
    const features=['popup=yes','toolbar=no','location=no','status=no','menubar=no','scrollbars=yes','resizable=yes',`width=${w}`,`height=${h}`,`left=${left}`,`top=${top}`].join(',');
    panelWin = window.open(url, 'panel_claim_window', features);
    if(!panelWin){ alert('Sila benarkan pop-up untuk domain ini.'); window.open(url, 'panel_claim_window'); return; }
    panelWin.focus();
  }

  /* ============== REG PANEL DATA ============== */
  let filterDropdownReady=false;
  async function buildRegPanelMap(){
    regPanelMap.clear();
    try{
      const res = await fetch(\`\${API_BASE}?action=listregpanel\`);
      const json = await res.json();
      if(json.status!=='ok') return;
      const items = (json.data && (json.data.items || json.data)) || [];
      for(const p of items){
        const key = String(p.panel_name||'').toLowerCase().trim();
        regPanelMap.set(key, {
          panel_name: p.panel_name||'',
          pic_name: p.pic_name||'',
          pic_phone: p.pic_phone||'',
          panel_link: p.panel_link || p.login_url || p.claim_url_template || '',
          payment_terms_days: parseInt(p.payment_terms_days,10) || parseInt(p.payment_terms,10) || '',
          notes: p.notes || ''
        });
      }
    }catch(e){ console.warn('Gagal muat Reg Panel map', e); }
  }
  async function populatePanelDropdown(){
    if(filterDropdownReady) return;
    const select = el('#filterPanelSelect');
    select.innerHTML = '<option value="">Semua Panel</option>';
    const names = Array.from(regPanelMap.keys()).sort((a,b)=> a.localeCompare(b,'ms',{sensitivity:'base'}));
    for(const name of names){
      const opt = document.createElement('option'); opt.value = name; opt.textContent = name.replace(/\\b\\w/g, c=>c.toUpperCase()); select.appendChild(opt);
    }
    filterDropdownReady=true;
  }

  /* ============== SLA util ============== */
  function deriveSLA(record){
    const terms = (()=>{ const key = String(record.jenis_panel||'').toLowerCase().trim(); const rp = regPanelMap.get(key); return rp && rp.payment_terms_days ? rp.payment_terms_days : null; })();
    let due = record.sla_due_at ? new Date(record.sla_due_at) : null;
    if ((!due || isNaN(due)) && record.status_claim==='Submitted' && terms){
      const base = record.submitted_at ? new Date(record.submitted_at) : new Date();
      if(!isNaN(base)) { due = new Date(base); due.setDate(due.getDate()+terms); }
    }
    if(!due || isNaN(due)) return { label:'', cls:'', dueText:'' };
    const today = new Date(); today.setHours(0,0,0,0);
    const dd = new Date(due); dd.setHours(0,0,0,0);
    let cls='on', label='On Track';
    if(dd.getTime() < today.getTime()){ cls='over'; label='Overdue'; }
    else if(dd.getTime() === today.getTime()){ cls='today'; label='Due Today'; }
    return { label, cls, dueText: formatDateDDMMYYYY_HHMM(due) };
  }

  /* ============== TABS ============== */
  function setActiveTab(tab){
    state.tab = tab;
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab));
    const isReg = tab==='regpanel';
    el('#recordsView').style.display = isReg ? 'none' : '';
    el('#regPanelView').style.display = isReg ? '' : 'none';
    el('#searchBar').style.display   = isReg ? 'none' : '';
    if(isReg){ loadRegPanel(); } else { state.page=1; load(); }
  }

  /* ============== LOAD RECORDS ============== */
  async function load(){
    if(regPanelMap.size===0){ await buildRegPanelMap(); await populatePanelDropdown(); }
    const url = \`\${API_BASE}?action=listrecords&statusTab=\${encodeURIComponent(state.tab)}&page=\${state.page}&pageSize=\${state.pageSize}&q=\${encodeURIComponent(state.q)}\`;
    try{
      showLoading();
      const res = await fetch(url);
      const json = await res.json();
      if(json.status!=='ok') throw new Error(json.message||'Gagal memuat data');
      const {total, items} = json.data;

      // filter panel
      let filtered = items.slice();
      if(state.filterPanelSelect){
        const key = state.filterPanelSelect.toLowerCase();
        filtered = filtered.filter(r => String(r.jenis_panel||'').toLowerCase() === key);
      }
      if(state.filterPanelText){
        const t = state.filterPanelText.toLowerCase();
        filtered = filtered.filter(r => String(r.jenis_panel||'').toLowerCase().includes(t));
      }
      if(state.tab==='submitted' && state.filterSLA){
        filtered = filtered.filter(r => deriveSLA(r).cls === state.filterSLA);
      }

      const sorted = sortItems(filtered);
      renderTable(sorted);
      updateBadgesApprox(sorted);
    }catch(e){ console.error(e); toast('Ralat memuat data'); }
    finally{ hideLoading(); }
  }

  function parseDate(value){
    if(!value) return null;
    if(value instanceof Date) return value;
    const s=String(value);
    if(/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) return new Date(s+'T00:00:00');
    const d=new Date(s); return isNaN(d.getTime())?null:d;
  }
  function sortItems(items){
    const m = state.sort;
    if(m==='panel_az' || m==='panel_za'){
      items.sort((a,b)=> String(a.jenis_panel||'').localeCompare(String(b.jenis_panel||''),'ms',{sensitivity:'base'}));
      if(m==='panel_za') items.reverse(); return items;
    }
    if(m==='nama_az' || m==='nama_za'){
      items.sort((a,b)=> String(a.nama_pesakit||'').localeCompare(String(b.nama_pesakit||''),'ms',{sensitivity:'base'}));
      if(m==='nama_za') items.reverse(); return items;
    }
    items.sort((a,b)=>{ const da=parseDate(a.tarikh_hadir), db=parseDate(b.tarikh_hadir); const ta=da?da.getTime():0, tb=db?db.getTime():0; return tb - ta; });
    if(m==='tarikh_asc') items.reverse();
    return items;
  }

  function num(x){ const n=parseFloat(String(x||'').replace(/[^\\d.]/g,''))||0; return n.toFixed(2); }

  function renderTable(items){
    if(pageInfo) pageInfo.textContent = \`Halaman \${state.page} • \${items.length} rekod\`;
    tbody.innerHTML = items.map(r => renderRow(r)).join('');
    items.forEach(r => wireRow(r));
  }

  function renderRow(r){
    const status = (r.status_claim||'Not Started');
    const chipClass = status==='Done'||status==='Submitted' ? 'done' : (status==='Rejected' ? 'rejected' : 'inprocess');

    const panelKey = String(r.jenis_panel||'').toLowerCase().trim();
    const reg = regPanelMap.get(panelKey);

    // WA Pesakit
    const waPatientURL = r.no_telefon ? buildWAUrl(r.no_telefon, \`Assalamualaikum/Hi \${r.nama_pesakit||''}\`) : '';
    const waPatientIcon = waPatientURL ? \`<a class="wa" href="javascript:void(0)" aria-label="WhatsApp Pesakit" title="WhatsApp Pesakit" onclick="openOrReusePanel('\${waPatientURL.replace(/'/g,"%27")}')">\${waSVG}</a>\` : '';

    // WA PIC
    const waPICURL = (reg && reg.pic_phone) ? buildWAUrl(reg.pic_phone, \`Hi \${reg.pic_name||'PIC'}, rujukan tuntutan: \${r.record_id||''}\`) : '';
    const waPICIcon = waPICURL ? \`<a class="wa" href="javascript:void(0)" aria-label="WhatsApp PIC Panel" title="WhatsApp PIC Panel" onclick="openOrReusePanel('\${waPICURL.replace(/'/g,"%27")}')">\${waSVG}</a>\` : '';

    const price = \`<div class="muted">
      Consult RM\${num(r.harga_consultation)} · Ubat RM\${num(r.harga_ubat)} · Prosedur RM\${num(r.harga_prosedur)}<br>
      <b style="color:#0a7a2a">Jumlah RM\${num(r.harga_jumlah)}</b>
    </div>\`;

    const sla = deriveSLA(r);
    const slaBadge = sla.cls ? \`<span class="sla \${sla.cls}" title="Due: \${sla.dueText}">\${sla.label}</span>\` : '';

    const submittedActions = state.tab==='submitted'
      ? \`<button class="secondary btn-pending" title="Masih menunggu">Pending</button>
         <button class="btn-done" title="Tanda Done">Done</button>
         <button class="btn-rejected" title="Tanda Rejected">Rejected</button>\`
      : '';

    return \`<tr data-id="\${escapeHtml(r.record_id)}">
      <td>\${escapeHtml(r.nama_pesakit||'')}</td>
      <td>\${escapeHtml(r.no_ic||'')}</td>
      <td>
        <div style="display:flex;align-items:center;gap:10px">
          <span>\${escapeHtml(r.no_telefon||'')}</span>\${waPatientIcon||''}
        </div>
      </td>
      <td>\${formatDateDDMMYYYY_HHMM(r.tarikh_hadir)}</td>
      <td>
        <div><b>\${escapeHtml(r.jenis_panel||'')}</b>\${slaBadge}</div>
        \${reg ? \`<div class="muted" style="margin-top:6px">
          \${escapeHtml(reg.pic_name||'-')}<br>
          <div style="display:flex;align-items:center;gap:10px">
            <small>\${escapeHtml(reg.pic_phone||'')}</small>\${waPICIcon||''}
          </div>
        </div>\` : ''}
      </td>
      <td>\${price}</td>
      <td>\${escapeHtml(r.jenis_ubat||'')}</td>
      <td><span class="chip \${chipClass}">\${escapeHtml(status)}</span></td>
      <td class="actions">
        <button class="secondary btn-open" title="Buka laman panel">Open</button>
        \${state.tab==='inprocess'
          ? \`<button class="btn-submit" title="Hantar ke Submitted">Submit</button>\`
          : submittedActions
        }
      </td>
    </tr>\`;
  }

  function wireRow(r){
    const tr = tbody.querySelector(\`tr[data-id="\${CSS.escape(String(r.record_id))}"]\`);
    tr.querySelector('.btn-open').addEventListener('click', ()=>{
      const url = r.panel_claim_url || (()=>{
        const key = String(r.jenis_panel||'').toLowerCase().trim();
        const reg = regPanelMap.get(key);
        return reg && reg.panel_link ? reg.panel_link : '';
      })();
      if(!url){ toast('URL panel tiada'); return; }
      openOrReusePanel(url);
    });

    if (state.tab==='inprocess') {
      tr.querySelector('.btn-submit')?.addEventListener('click', async ()=>{
        const ref = prompt('Masukkan Claim Ref/ID (jika ada):', r.claim_ref_id||'');
        if (ref === null) { toast('Dibatalkan.'); return; }
        await updateStatus(r.record_id, { status_claim: 'Submitted', claim_ref_id: ref });
      });
    } else if (state.tab==='submitted') {
      tr.querySelector('.btn-pending')?.addEventListener('click', async ()=>{ await updateStatus(r.record_id, { status_claim: 'Submitted' }); });
      tr.querySelector('.btn-done')?.addEventListener('click', async ()=>{
        const ref = prompt('Masukkan Claim Ref/ID (jika belum diisi):', r.claim_ref_id||'');
        if (ref === null) { toast('Dibatalkan.'); return; }
        await updateStatus(r.record_id, { status_claim: 'Done', claim_ref_id: ref });
      });
      tr.querySelector('.btn-rejected')?.addEventListener('click', async ()=>{
        const reason = prompt('Sebab Rejected (optional):','');
        if (reason === null) { toast('Dibatalkan.'); return; }
        await updateStatus(r.record_id, { status_claim: 'Rejected', notes: reason||'' });
      });
    }
  }

  // POST util (urlencoded untuk elak preflight)
  async function postForm(action, obj){
    showLoading();
    try{
      const body = new URLSearchParams(); body.set('payload', JSON.stringify(obj||{}));
      const res = await fetch(\`\${API_BASE}?action=\${encodeURIComponent(action)}\`, { method:'POST', body });
      const json = await res.json().catch(()=>null);
      if(!json || json.status!=='ok') throw new Error((json && json.message) || 'Request gagal');
      return json;
    }finally{ hideLoading(); }
  }
  async function updateStatus(record_id, payload){
    try{
      const tr = tbody.querySelector(\`tr[data-id="\${CSS.escape(String(record_id))}"]\`);
      if(tr && payload.status_claim){
        const chip=tr.querySelector('.chip');
        chip.textContent = payload.status_claim;
        chip.className = 'chip ' + (payload.status_claim==='Rejected' ? 'rejected' : (payload.status_claim==='Done'||payload.status_claim==='Submitted' ? 'done' : 'inprocess'));
      }
      await postForm('updateclaimstatus', { record_id, ...payload });
      toast('Status dikemas kini');
      await load();
    }catch(e){ toast(e.message||'Gagal kemas status'); await load(); }
  }
  function updateBadgesApprox(items){
    const count={inprocess:0, submitted:0, done:0, rejected:0};
    items.forEach(r=>{ const s=(r.status_claim||'Not Started'); if(s==='Done') count.done++; else if(s==='Rejected') count.rejected++; else if(s==='Submitted') count.submitted++; else count.inprocess++; });
    el('#badge-inprocess').textContent=String(count.inprocess);
    el('#badge-submitted').textContent=String(count.submitted);
    el('#badge-done').textContent=String(count.done);
    el('#badge-rejected').textContent=String(count.rejected);
  }

  /* ====== REG PANEL LIST/EDIT ====== */
  async function loadRegPanel(){
    try{
      showLoading();
      const res = await fetch(\`\${API_BASE}?action=listregpanel\`);
      const json = await res.json();
      if(json.status!=='ok') throw new Error(json.message||'Gagal memuat Reg Panel');
      const items = (json.data && (json.data.items || json.data)) || [];
      const tbodyRP = document.getElementById('rp_tbody');
      tbodyRP.innerHTML = items.map(p => renderRegRow(p)).join('');
      tbodyRP.querySelectorAll('tr').forEach(tr => wireRegRow(tr));
      await buildRegPanelMap();
      await populatePanelDropdown();
    }catch(e){ console.error(e); toast('Ralat memuat Reg Panel'); }
    finally{ hideLoading(); }
  }

  function renderRegRow(p){
    const link = escapeHtml(p.panel_link || p.login_url || p.claim_url_template || '');
    const waHref = p.pic_phone ? buildWAUrl(p.pic_phone, \`Hi \${p.pic_name||'PIC'} — pesanan dari klinik\`) : '';
    const waBtn = waHref ? \`<a class="wa" href="javascript:void(0)" onclick="openOrReusePanel('\${waHref.replace(/'/g,"%27")}')" title="WhatsApp PIC">\${waSVG}</a>\` : '';
    const terms = parseInt(p.payment_terms_days,10) || '';

    return \`<tr data-panel="\${escapeHtml(p.panel_name||'')}">
      <td class="cell-name"><span class="view">\${escapeHtml(p.panel_name||'')}</span><input class="edit" style="display:none" value="\${escapeHtml(p.panel_name||'')}" /></td>
      <td class="cell-link"><span class="view"><a href="\${link||'#'}" target="_blank" rel="noopener">Buka</a></span><input class="edit" style="display:none" value="\${escapeHtml(link)}" /></td>
      <td class="cell-picname"><span class="view">\${escapeHtml(p.pic_name||'')}</span><input class="edit" style="display:none" value="\${escapeHtml(p.pic_name||'')}" /></td>
      <td class="cell-picphone"><span class="view">\${escapeHtml(p.pic_phone||'')}</span><input class="edit" style="display:none" value="\${escapeHtml(p.pic_phone||'')}" /></td>
      <td class="cell-terms"><span class="view">\${escapeHtml(String(terms))}</span><input class="edit" style="display:none" type="number" min="1" step="1" value="\${escapeHtml(String(terms))}" /></td>
      <td class="cell-notes"><span class="view">\${escapeHtml(p.notes||'')}</span><input class="edit" style="display:none" value="\${escapeHtml(p.notes||'')}" /></td>
      <td>\${waBtn}</td>
      <td class="actions">
        <button class="btn-warning btn-rp-edit">Edit</button>
        <button class="btn-danger btn-rp-del">Padam</button>
        <button class="btn-save" style="display:none">Save</button>
        <button class="secondary btn-cancel" style="display:none">Cancel</button>
      </td>
    </tr>\`;
  }
  function wireRegRow(tr){
    const btnEdit = tr.querySelector('.btn-rp-edit');
    const btnDel  = tr.querySelector('.btn-rp-del');
    const btnSave = tr.querySelector('.btn-save');
    const btnCancel=tr.querySelector('.btn-cancel');

    function setEditMode(on){
      tr.querySelectorAll('.view').forEach(e=> e.style.display = on ? 'none' : '');
      tr.querySelectorAll('.edit').forEach(e=> { e.style.display = on ? '' : 'none'; e.classList.add('inline-input'); });
      btnEdit.style.display = on ? 'none' : '';
      btnDel.style.display  = on ? 'none' : '';
      btnSave.style.display = on ? '' : 'none';
      btnCancel.style.display= on ? '' : 'none';
    }

    btnEdit.addEventListener('click', ()=> setEditMode(true));
    btnCancel.addEventListener('click', ()=> setEditMode(false));

    btnSave.addEventListener('click', async ()=>{
      const name = tr.querySelector('.cell-name .edit').value.trim();
      const link = tr.querySelector('.cell-link .edit').value.trim();
      const picn = tr.querySelector('.cell-picname .edit').value.trim();
      const picp = tr.querySelector('.cell-picphone .edit').value.trim();
      const terms= parseInt(tr.querySelector('.cell-terms .edit').value,10);
      const notes= tr.querySelector('.cell-notes .edit').value.trim();
      if(!name || !link || !Number.isFinite(terms) || terms<=0){ toast('Isi Nama, Link & Tempoh hari'); return; }
      try{
        await postForm('updateregpanel', { panel_name:name, panel_link:link, pic_name:picn, pic_phone:picp, payment_terms_days:terms, notes });
        toast('Panel dikemas kini'); await loadRegPanel();
      }catch(e){ console.error(e); toast('Gagal kemas panel'); }
    });

    btnDel.addEventListener('click', async ()=>{
      const name = tr.getAttribute('data-panel');
      if(!confirm(\`Padam panel "\${name}"?\`)) return;
      try{ await postForm('deleteregpanel', { panel_name:name }); toast('Panel dipadam'); await loadRegPanel(); }
      catch(e){ console.error(e); toast('Gagal padam panel'); }
    });
  }

  async function saveRegPanel(){
    const name = el('#rp_name').value.trim();
    const link = el('#rp_link').value.trim();
    const picName = el('#rp_pic_name').value.trim();
    const picPhone = el('#rp_pic_phone').value.trim();
    const termsDays = parseInt(el('#rp_terms_days').value,10);
    const notes = el('#rp_notes').value.trim();

    if(!name || !link || !Number.isFinite(termsDays) || termsDays<=0){ toast('Sila isi Nama Panel, Link dan Tempoh (hari).'); return; }
    try{
      await postForm('updateregpanel', { panel_name: name, panel_link: link, pic_name: picName||'', pic_phone: picPhone||'', payment_terms_days: termsDays, notes: notes||'' });
      toast('Panel disimpan.'); clearRegPanelForm(); await loadRegPanel();
    }catch(e){ console.error(e); toast('Gagal simpan panel'); }
  }
  function clearRegPanelForm(){ ['#rp_name','#rp_link','#rp_pic_name','#rp_pic_phone','#rp_terms_days','#rp_notes'].forEach(id=> el(id).value=''); }

  /* ============== EVENTS ============== */
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));
  el('#search').addEventListener('input', e => { state.q = e.target.value.trim(); state.page=1; load(); });
  el('#filterPanelSelect').addEventListener('change', e => { state.filterPanelSelect = e.target.value; state.page=1; load(); });
  el('#filterPanelText').addEventListener('input', e => { state.filterPanelText = e.target.value.trim(); state.page=1; load(); });
  el('#filterSLA').addEventListener('change', e => { state.filterSLA = e.target.value; state.page=1; load(); });
  el('#sort').addEventListener('change', e => { state.sort = e.target.value; state.page=1; load(); });
  el('#pageSize').addEventListener('change', e => { state.pageSize = parseInt(e.target.value,10)||50; state.page=1; load(); });
  el('#refresh').addEventListener('click', load);
  el('#prev').addEventListener('click', ()=>{ if(state.page>1){ state.page--; load(); }});
  el('#next').addEventListener('click', ()=>{ state.page++; load(); });

  document.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.id==='rp_save'){ saveRegPanel(); }
    if(ev.target && ev.target.id==='rp_clear'){ clearRegPanelForm(); toast('Bersih.'); }
  });

  // INIT
  setActiveTab('inprocess'); // atau 'regpanel' untuk uji dulu
  </script>
</body>
</html>
