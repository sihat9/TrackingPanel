<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Claims Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />
  <style>
    :root {
      --primary:#2c3e50; --primary-light:#34495e; --muted:#7f8c8d;
      --warning:#f39c12; --danger:#e74c3c; --success:#27ae60; --border:#d1d5db;
      --bg:#ecf0f1; --wa:#25D366;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:'Segoe UI',Roboto,system-ui,sans-serif;background:var(--bg);color:#2c3e50;font-size:14px;line-height:1.6}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10;box-shadow:0 2px 6px rgba(0,0,0,.06)}
    .tabs{display:flex;gap:8px;align-items:center;padding:12px 16px;flex-wrap:wrap;background:#fff}
    .tab{padding:10px 14px;border-radius:8px;border:1px solid var(--border);background:#fff;cursor:pointer;color:var(--muted);display:flex;gap:8px;align-items:center;font-weight:600}
    .tab:hover{background:#f8fafc;border-color:var(--primary);color:var(--primary)}
    .tab.active{background:var(--primary);color:#fff;border-color:var(--primary)}
    .badge{display:inline-flex;align-items:center;justify-content:center;min-width:20px;height:20px;padding:0 6px;border-radius:10px;background:rgba(255,255,255,.25);color:#fff;font-size:12px;font-weight:700}
    .search{padding:14px 16px;display:flex;gap:10px;flex-wrap:wrap;align-items:center;background:#f6f8fb;border-top:1px solid var(--border)}
    input[type="text"],input[type="url"],input[type="tel"],input[type="number"],select,textarea{padding:10px 12px;border:1px solid var(--border);border-radius:8px;background:#fff;min-width:170px}
    input:focus,select:focus,textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 2px rgba(44,62,80,.12)}
    button{padding:10px 14px;border-radius:8px;border:1px solid var(--primary);background:var(--primary);color:#fff;cursor:pointer;display:inline-flex;gap:8px;align-items:center;font-weight:600}
    button:hover{background:var(--primary-light);border-color:var(--primary-light);transform:translateY(-1px)}
    button.secondary{background:#fff;color:var(--primary)}
    .container{display:grid;grid-template-columns:1fr;gap:20px;padding:20px;max-width:1600px;margin:0 auto}
    @media(min-width:1200px){.container{grid-template-columns:62.5% 37.5%;}}
    .left,.right{background:#fff;border:1px solid var(--border);border-radius:10px;box-shadow:0 2px 6px rgba(0,0,0,.05);min-height:700px;display:flex;flex-direction:column;overflow:hidden}
    .right{position:sticky;top:100px;max-height:calc(100vh - 140px)}
    .section-title{padding:14px 16px;background:#f6f8fb;border-bottom:1px solid var(--border);font-size:16px;font-weight:700}
    .hint{padding:12px 16px;background:#eaf4ff;border-bottom:1px solid var(--border);font-size:13px;color:#0b4a91}
    table{width:100%;border-collapse:collapse;background:#fff}
    thead th{position:sticky;top:0;background:#f9fafb;border-bottom:1px solid var(--border);z-index:1}
    th,td{padding:12px 10px;border-bottom:1px solid #eef2f7;text-align:left;font-size:13px;vertical-align:top}
    tr:hover{background:rgba(44,62,80,.03)}
    .price{font-size:11px;color:#6b7280;line-height:1.4}
    .chip{display:inline-flex;align-items:center;padding:4px 10px;border-radius:16px;font-size:11px;font-weight:700;border:1px solid}
    .chip.inprocess{background:#fff9e6;border-color:var(--warning);color:#7a5200}
    .chip.submitted{background:#e6f3ff;border-color:#3b82f6;color:#0b4a91}
    .chip.done{background:#e6ffed;border-color:var(--success);color:#125c2a}
    .chip.rejected{background:#ffe6e6;border-color:var(--danger);color:#7a1d1d}
    .sla{display:inline-flex;align-items:center;border-radius:16px;padding:4px 10px;font-size:11px;font-weight:600;border:1px solid;margin-left:6px}
    .sla.on{background:#e6ffed;border-color:var(--success);color:#125c2a}
    .sla.today{background:#fffbe6;border-color:var(--warning);color:#7a5200}
    .sla.over{background:#ffe6e6;border-color:var(--danger);color:#7a1d1d}
    .actions{display:flex;gap:6px;flex-wrap:wrap;align-items:center}
    .pagination{margin-top:auto;padding:12px 16px;background:#f6f8fb;border-top:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
    .page-info{font-size:12px;color:#6b7280}
    .wa{display:inline-flex;align-items:center;justify-content:center;width:32px;height:32px;background:#fff;border:none;box-shadow:0 2px 4px rgba(0,0,0,.08);border-radius:6px;color:#128C7E}
    .wa .fa-whatsapp{font-size:18px;color:#25D366}
    .toast{position:fixed;right:18px;bottom:18px;background:#1f2937;color:#fff;padding:12px 14px;border-radius:8px;opacity:0;transform:translateY(10px);transition:.3s;z-index:1000;display:flex;gap:8px;align-items:center}
    .toast.show{opacity:1;transform:translateY(0)}
    .loading{position:fixed;inset:0;background:rgba(255,255,255,.75);backdrop-filter:blur(3px);display:none;align-items:center;justify-content:center;z-index:9999}
    .loading.show{display:flex}
    .spinner{width:48px;height:48px;border-radius:50%;border:4px solid #ddd;border-top-color:var(--primary);animation:spin .8s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    /* Magnifier */
    .magnifier-tooltip{position:fixed;background:#fff;border:1px solid var(--border);border-radius:8px;padding:12px;box-shadow:0 8px 24px rgba(0,0,0,.15);z-index:10000;max-width:380px;font-size:14px;line-height:1.5;pointer-events:none;opacity:0;transform:scale(.96);transition:opacity .16s, transform .16s}
    .magnifier-tooltip.show{opacity:1;transform:scale(1)}
    .magnifier-title{font-weight:700;margin-bottom:8px;color:var(--primary);font-size:13px;border-bottom:1px solid var(--border);padding-bottom:4px}
    .magnifiable{cursor:pointer}
    /* Inline edit inputs */
    .inline-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:6px;font-size:13px}
  </style>
</head>
<body>
  <header>
    <div class="tabs">
      <div class="tab active" data-tab="inprocess"><i class="fas fa-spinner"></i> Panel (In Process) <span id="badge-inprocess" class="badge">0</span></div>
      <div class="tab" data-tab="submitted"><i class="fas fa-paper-plane"></i> Panel (Submitted) <span id="badge-submitted" class="badge">0</span></div>
      <div class="tab" data-tab="done"><i class="fas fa-check-circle"></i> Panel (Done) <span id="badge-done" class="badge">0</span></div>
      <div class="tab" data-tab="rejected"><i class="fas fa-times-circle"></i> Panel (Rejected) <span id="badge-rejected" class="badge">0</span></div>
      <div class="tab" data-tab="regpanel"><i class="fas fa-cog"></i> Reg Panel</div>
    </div>
    <div class="search" id="searchBar">
      <input id="search" type="text" placeholder="Cari nama/IC..." />
      <select id="filterPanelSelect" title="Tapis Jenis Panel"><option value="">Semua Panel</option></select>
      <input id="filterPanelText" type="text" placeholder="Tulis nama panel..." />
      <select id="sort">
        <option value="tarikh_desc">Tarikh Hadir: Terbaru</option>
        <option value="tarikh_asc">Tarikh Hadir: Terdahulu</option>
        <option value="panel_az">Jenis Panel: A → Z</option>
        <option value="panel_za">Jenis Panel: Z → A</option>
        <option value="nama_az">Nama Pesakit: A → Z</option>
        <option value="nama_za">Nama Pesakit: Z → A</option>
      </select>
      <select id="filterSLA" title="Status SLA">
        <option value="">SLA: Semua</option>
        <option value="over">SLA: Overdue</option>
        <option value="today">SLA: Due Today</option>
        <option value="on">SLA: On Track</option>
      </select>
      <select id="pageSize" title="Rekod per halaman">
        <option>25</option><option selected>50</option><option>100</option>
      </select>
      <button id="refresh" class="secondary"><i class="fas fa-sync-alt"></i> Refresh</button>
    </div>
  </header>

  <div class="container">
    <section class="left">
      <div id="recordsView">
        <div class="section-title">Senarai Tuntutan Panel</div>
        <table>
          <thead>
            <tr>
              <th>Nama</th>
              <th>IC</th>
              <th>Telefon</th>
              <th>Tarikh Hadir</th>
              <th>Panel / PIC</th>
              <th>Harga</th>
              <th>Ubat</th>
              <th>Status</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="pagination">
          <button id="prev" class="secondary"><i class="fas fa-chevron-left"></i> Prev</button>
          <span id="pageInfo" class="page-info"></span>
          <button id="next" class="secondary">Next <i class="fas fa-chevron-right"></i></button>
        </div>
      </div>

      <div id="regPanelView" style="display:none">
        <div class="section-title">Pendaftaran Panel</div>
        <div style="padding:16px;display:grid;grid-template-columns:1fr;gap:12px">
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:12px">
            <div><label>Nama Panel *</label><input id="rp_name" type="text" placeholder="Contoh: AIA" required /></div>
            <div><label>Link Panel (URL) *</label><input id="rp_link" type="url" placeholder="https://..." required /></div>
            <div><label>Nama PIC</label><input id="rp_pic_name" type="text" placeholder="Contoh: En. Ahmad" /></div>
            <div><label>No. Telefon PIC</label><input id="rp_pic_phone" type="tel" placeholder="0123456789" /></div>
            <div><label>Tempoh (hari) *</label><input id="rp_terms_days" type="number" min="1" step="1" placeholder="cth: 30" /></div>
            <div style="grid-column:1/-1"><label>Catatan</label><textarea id="rp_notes" placeholder="Nota tambahan jika perlu" style="width:100%;min-height:80px"></textarea></div>
          </div>
          <div style="display:flex;gap:8px">
            <button id="rp_save"><i class="fas fa-save"></i> Simpan Panel</button>
            <button id="rp_clear" class="secondary"><i class="fas fa-eraser"></i> Clear</button>
          </div>
        </div>
        <div class="section-title">Senarai Panel Berdaftar</div>
        <div style="padding:12px">
          <table>
            <thead>
              <tr>
                <th>Nama</th>
                <th>Link</th>
                <th>PIC</th>
                <th>Telefon PIC</th>
                <th>Tempoh (hari)</th>
                <th>Catatan</th>
                <th>WhatsApp</th>
                <th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="rp_tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside class="right">
      <div class="section-title">Panel Window</div>
      <div class="hint"><i class="fas fa-info-circle"></i> Klik <b>Open</b> atau ikon <b>WhatsApp</b>. Tetingkap kanan dibuka sekali & dikitar semula.</div>
      <div id="detail" style="padding:16px;color:#6b7280;text-align:center">Pilih rekod untuk melihat butiran</div>
    </aside>
  </div>

  <div id="magnifierTooltip" class="magnifier-tooltip">
    <div id="magnifierTitle" class="magnifier-title"></div>
    <div id="magnifierContent"></div>
  </div>
  <div id="toast" class="toast" role="status" aria-live="polite"><i class="fas fa-check-circle"></i><span class="toast-message"></span></div>
  <div id="loading" class="loading" aria-live="polite"><div class="spinner" title="Loading..."></div></div>

  <script>
  // ====== CONFIG ======
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzkhLra1C5rg2HWY2oc3LlkLmBbKTtTbqThN7P0kpqC7z4b6yfMRJLXm4BBLkPzSko/exec';

  // ====== STATE ======
  let state = { tab:'inprocess', page:1, pageSize:50, q:'', sort:'tarikh_desc', filterPanelSelect:'', filterPanelText:'', filterSLA:'' };
  let panelWin = null, lastOpenTs = 0;
  let regPanelMap = new Map();

  // ====== HELPERS ======
  const el = s => document.querySelector(s);
  const tbody = el('#tbody');
  const pageInfo = el('#pageInfo');
  const toastEl = el('#toast');
  const toastMsg = el('.toast-message');
  const loader = el('#loading');

  function toast(m, type='info'){
    const icon = type==='error' ? 'fa-exclamation-circle' : type==='warning' ? 'fa-exclamation-triangle' : type==='success' ? 'fa-check-circle' : 'fa-info-circle';
    toastEl.innerHTML = '<i class="fas '+icon+'"></i><span class="toast-message"></span>';
    el('.toast-message').textContent = m;
    toastEl.classList.add('show');
    setTimeout(()=>toastEl.classList.remove('show'), 2600);
  }
  function showLoading(){ loader.classList.add('show'); }
  function hideLoading(){ loader.classList.remove('show'); }
  const toDigits = s => String(s||'').replace(/[^0-9]/g,'');
  function buildWAUrl(phone, text){ const p=toDigits(phone); const q=encodeURIComponent(text||''); return p ? 'https://web.whatsapp.com/send?phone='+p+(q?'&text='+q:'') : ''; }
  function pad2(n){ return String(n).padStart(2,'0'); }
  function formatDateDDMMYYYY_HHMM(v){
    if(!v) return '';
    const d = (v instanceof Date) ? v : (/^\\d{4}-\\d{2}-\\d{2}$/.test(String(v)) ? new Date(String(v)+'T00:00:00') : new Date(v));
    if(isNaN(d.getTime())) return String(v);
    return pad2(d.getDate())+'/'+pad2(d.getMonth()+1)+'/'+d.getFullYear()+' '+pad2(d.getHours())+':'+pad2(d.getMinutes());
  }
  function escapeHTML(s){ return String(s??'').replace(/[&<>]/g, m=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[m])); }
  function escapeAttr(s){
    return String(s??'')
      .replace(/&/g,'&amp;')
      .replace(/"/g,'&quot;')
      .replace(/</g,'&lt;')
      .replace(/>/g,'&gt;')
      .replace(/[\\r\\n]+/g,' ')
      .replace(/\\u2028|\\u2029/g,' ');
  }

  // ====== SINGLE SIDE WINDOW (reuse) ======
  function openOrReusePanel(url){
    if(!url) return;
    const now = Date.now(); if(now-lastOpenTs<250) return; lastOpenTs = now;
    try{
      if(panelWin && !panelWin.closed){
        try{ const current = String(panelWin.location.href||''); if(current===String(url)){ panelWin.focus(); return; } }catch(_){}
        panelWin.location.href = url; panelWin.focus(); return;
      }
    }catch(_){}
    const sw=window.screen.availWidth, sh=window.screen.availHeight;
    const w=Math.max(520, Math.round(sw*0.34)), h=Math.max(650, sh);
    const left=Math.max(0, sw-w), top=0;
    const features = ['popup=yes','toolbar=no','location=no','status=no','menubar=no','scrollbars=yes','resizable=yes','width='+w,'height='+h,'left='+left,'top='+top].join(',');
    panelWin = window.open(url, 'panel_claim_window', features);
    if(!panelWin){ alert('Sila benarkan pop-up untuk domain ini.'); window.open(url, 'panel_claim_window'); return; }
    panelWin.focus();
  }

  // ====== MAGNIFIER ======
  (function initMagnifier(){
    const tooltip = el('#magnifierTooltip');
    const titleEl = el('#magnifierTitle');
    const contentEl = el('#magnifierContent');
    let tHandle=null;
    document.addEventListener('mouseover', (ev)=>{
      const target = ev.target.closest('.magnifiable[data-title]');
      if(!target){ tooltip.classList.remove('show'); return; }
      if(tHandle) clearTimeout(tHandle);
      tHandle = setTimeout(()=>{
        const rect = target.getBoundingClientRect();
        titleEl.textContent = target.dataset.title || 'Butiran';
        contentEl.textContent = target.dataset.content || target.textContent || '';
        let top = rect.top - tooltip.offsetHeight - 10;
        let left = rect.left + rect.width/2 - tooltip.offsetWidth/2;
        if(top < 10) top = rect.bottom + 10;
        if(left < 10) left = 10;
        if(left + tooltip.offsetWidth > window.innerWidth-10) left = window.innerWidth - tooltip.offsetWidth - 10;
        tooltip.style.top = top+'px'; tooltip.style.left = left+'px'; tooltip.classList.add('show');
      }, 380);
    });
    document.addEventListener('mouseout', (ev)=>{
      if(ev.relatedTarget && ev.relatedTarget.closest && ev.relatedTarget.closest('#magnifierTooltip')) return;
      tooltip.classList.remove('show');
    });
  })();

  // ====== REG PANEL MAP ======
  async function buildRegPanelMap(){
    regPanelMap.clear();
    try{
      const res = await fetch(API_BASE+'?action=listregpanel');
      const json = await res.json();
      if(json.status!=='ok') return;
      const items = (json.data && (json.data.items || json.data)) || [];
      for(const p of items){
        const key = String(p.panel_name||'').toLowerCase().trim();
        regPanelMap.set(key, {
          panel_name: p.panel_name||'',
          pic_name: p.pic_name||'',
          pic_phone: p.pic_phone||'',
          panel_link: p.panel_link || p.login_url || p.claim_url_template || '',
          payment_terms_days: parseInt(p.payment_terms_days,10) || '',
          notes: p.notes || ''
        });
      }
    }catch(e){ console.warn('Gagal muat Reg Panel map', e); }
  }
  async function populatePanelDropdown(){
    const select = el('#filterPanelSelect');
    select.innerHTML = '<option value="">Semua Panel</option>';
    const names = Array.from(regPanelMap.keys()).sort((a,b)=> a.localeCompare(b,'ms',{sensitivity:'base'}));
    for(const name of names){
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name.replace(/\\b\\w/g, c=>c.toUpperCase());
      select.appendChild(opt);
    }
  }

  // ====== SLA util ======
  function deriveSLA(record){
    const key = String(record.jenis_panel||'').toLowerCase().trim();
    const rp = regPanelMap.get(key);
    const terms = rp && rp.payment_terms_days ? rp.payment_terms_days : null;
    let due = record.sla_due_at ? new Date(record.sla_due_at) : null;
    if((!due || isNaN(due)) && record.status_claim==='Submitted' && terms){
      const base = record.submitted_at ? new Date(record.submitted_at) : new Date();
      if(!isNaN(base)) { due = new Date(base); due.setDate(due.getDate()+terms); }
    }
    if(!due || isNaN(due)) return { label:'', cls:'', dueText:'' };
    const today = new Date(); today.setHours(0,0,0,0);
    const dd = new Date(due); dd.setHours(0,0,0,0);
    let cls='on', label='On Track';
    if(dd.getTime() < today.getTime()){ cls='over'; label='Overdue'; }
    else if(dd.getTime() === today.getTime()){ cls='today'; label='Due Today'; }
    return { label, cls, dueText: formatDateDDMMYYYY_HHMM(due) };
  }

  // ====== TABS ======
  function setActiveTab(tab){
    state.tab = tab;
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab));
    const isReg = tab==='regpanel';
    el('#recordsView').style.display = isReg ? 'none' : '';
    el('#regPanelView').style.display = isReg ? '' : 'none';
    el('#searchBar').style.display   = isReg ? 'none' : '';
    if(isReg){ loadRegPanel(); } else { state.page=1; load(); }
  }

  // ====== LOAD RECORDS ======
  async function load(){
    if(regPanelMap.size===0){ await buildRegPanelMap(); await populatePanelDropdown(); }
    const url = API_BASE+'?action=listrecords&statusTab='+encodeURIComponent(state.tab)+'&page='+state.page+'&pageSize='+state.pageSize+'&q='+encodeURIComponent(state.q);
    try{
      showLoading();
      const res = await fetch(url);
      const json = await res.json();
      if(json.status!=='ok') throw new Error(json.message||'Gagal memuat data');
      const { total, items } = json.data;

      let filtered = items.slice();
      if(state.filterPanelSelect){
        const key = state.filterPanelSelect.toLowerCase();
        filtered = filtered.filter(r => String(r.jenis_panel||'').toLowerCase() === key);
      }
      if(state.filterPanelText){
        const t = state.filterPanelText.toLowerCase();
        filtered = filtered.filter(r => String(r.jenis_panel||'').toLowerCase().includes(t));
      }
      if(state.tab==='submitted' && state.filterSLA){
        filtered = filtered.filter(r => deriveSLA(r).cls === state.filterSLA);
      }
      const sorted = sortItems(filtered);
      renderTable(sorted);
      updateBadgesApprox(sorted);
      pageInfo.textContent = 'Halaman '+state.page+' • '+sorted.length+' rekod';
    }catch(e){ console.error(e); toast('Ralat memuat data','error'); }
    finally{ hideLoading(); }
  }

  function parseDate(v){
    if(!v) return null; if(v instanceof Date) return v;
    const s=String(v); if(/^\\d{4}-\\d{2}-\\d{2}$/.test(s)) return new Date(s+'T00:00:00');
    const d=new Date(s); return isNaN(d.getTime())?null:d;
  }
  function sortItems(items){
    const m=state.sort;
    if(m==='panel_az' || m==='panel_za'){
      items.sort((a,b)=> String(a.jenis_panel||'').localeCompare(String(b.jenis_panel||''),'ms',{sensitivity:'base'}));
      if(m==='panel_za') items.reverse(); return items;
    }
    if(m==='nama_az' || m==='nama_za'){
      items.sort((a,b)=> String(a.nama_pesakit||'').localeCompare(String(b.nama_pesakit||''),'ms',{sensitivity:'base'}));
      if(m==='nama_za') items.reverse(); return items;
    }
    items.sort((a,b)=>{
      const da=parseDate(a.tarikh_hadir), db=parseDate(b.tarikh_hadir);
      const ta=da?da.getTime():0, tb=db?db.getTime():0; return tb-ta;
    });
    if(m==='tarikh_asc') items.reverse(); return items;
  }
  function num(x){ const n=parseFloat(String(x||'').replace(/[^0-9.]/g,''))||0; return n.toFixed(2); }

  function renderTable(items){
    const rows = items.map(r => {
      const status = String(r.status_claim||'Not Started');
      const chip = status==='Done' ? 'done' : status==='Rejected' ? 'rejected' : status==='Submitted' ? 'submitted' : 'inprocess';
      const panelKey = String(r.jenis_panel||'').toLowerCase().trim();
      const reg = regPanelMap.get(panelKey);
      const waPatientURL = r.no_telefon ? buildWAUrl(r.no_telefon, 'Assalamualaikum/Hi '+(r.nama_pesakit||'')) : '';
      const waPICURL = (reg && reg.pic_phone) ? buildWAUrl(reg.pic_phone, 'Hi '+(reg.pic_name||'PIC')+', rujukan tuntutan: '+(r.record_id||'')) : '';
      const priceTxt = 'Consult RM'+num(r.harga_consultation)+' · Ubat RM'+num(r.harga_ubat)+' · Prosedur RM'+num(r.harga_prosedur)+'\\nJumlah RM'+num(r.harga_jumlah);
      const sla = deriveSLA(r);
      const slaBadge = sla.cls ? '<span class="sla '+sla.cls+'" title="Due: '+escapeAttr(sla.dueText)+'">'+sla.label+'</span>' : '';

      return (
        '<tr data-id="'+escapeAttr(r.record_id)+'">'+
          '<td class="magnifiable" data-title="Nama Pesakit" data-content="'+escapeAttr(r.nama_pesakit||'')+'">'+escapeHTML(r.nama_pesakit||'')+'</td>'+
          '<td class="magnifiable" data-title="No. IC" data-content="'+escapeAttr(r.no_ic||'')+'">'+escapeHTML(r.no_ic||'')+'</td>'+
          '<td class="magnifiable" data-title="No. Telefon" data-content="'+escapeAttr(r.no_telefon||'')+'">'+
            '<div style="display:flex;align-items:center;gap:8px">'+
              '<span>'+escapeHTML(r.no_telefon||'')+'</span>'+
              (waPatientURL ? '<button class="wa btn-wa" type="button" data-url="'+escapeAttr(waPatientURL)+'" title="WhatsApp Pesakit"><i class="fab fa-whatsapp"></i></button>' : '')+
            '</div>'+
          '</td>'+
          '<td class="magnifiable" data-title="Tarikh Hadir" data-content="'+escapeAttr(formatDateDDMMYYYY_HHMM(r.tarikh_hadir))+'">'+escapeHTML(formatDateDDMMYYYY_HHMM(r.tarikh_hadir))+'</td>'+
          '<td class="magnifiable" data-title="Panel / PIC" data-content="'+escapeAttr((r.jenis_panel||'')+(reg?('\\nPIC: '+(reg.pic_name||'-')+'\\nTelefon: '+(reg.pic_phone||'')):''))+'">'+
            '<div><b>'+escapeHTML(r.jenis_panel||'')+'</b>'+slaBadge+'</div>'+
            (reg ? '<div class="price" style="margin-top:4px">'+
              escapeHTML(reg.pic_name||'-')+'<br>'+
              '<div style="display:flex;align-items:center;gap:8px"><small>'+escapeHTML(reg.pic_phone||'')+'</small>'+
              (waPICURL ? '<button class="wa btn-wa" type="button" data-url="'+escapeAttr(waPICURL)+'" title="WhatsApp PIC"><i class="fab fa-whatsapp"></i></button>' : '')+
              '</div></div>' : '')+
          '</td>'+
          '<td class="magnifiable" data-title="Harga" data-content="'+escapeAttr(priceTxt)+'">'+
            '<div class="price">Consult RM'+num(r.harga_consultation)+' · Ubat RM'+num(r.harga_ubat)+' · Prosedur RM'+num(r.harga_prosedur)+'<br><b>Jumlah RM'+num(r.harga_jumlah)+'</b></div>'+
          '</td>'+
          '<td class="magnifiable" data-title="Jenis Ubat" data-content="'+escapeAttr(r.jenis_ubat||'')+'">'+escapeHTML(r.jenis_ubat||'')+'</td>'+
          '<td><span class="chip '+chip+'">'+escapeHTML(status)+'</span></td>'+
          '<td class="actions">'+
            '<button class="secondary btn-open" type="button" title="Buka laman panel"><i class="fas fa-external-link-alt"></i></button>'+
            (state.tab==='inprocess' ?
              '<button class="btn-submit" type="button" title="Hantar ke Submitted"><i class="fas fa-paper-plane"></i></button>' :
              '<span class="submitted-actions">'+
                '<button class="secondary btn-pending" type="button" title="Masih menunggu"><i class="fas fa-clock"></i></button>'+
                '<button class="btn-done" type="button" title="Tanda Done"><i class="fas fa-check"></i></button>'+
                '<button class="btn-rejected" type="button" title="Tanda Rejected"><i class="fas fa-times"></i></button>'+
              '</span>'
            )+
          '</td>'+
        '</tr>'
      );
    }).join('');
    tbody.innerHTML = rows;
  }

  // Delegated events for table actions
  tbody.addEventListener('click', async (ev)=>{
    const tr = ev.target.closest('tr[data-id]'); if(!tr) return;
    const id = tr.getAttribute('data-id');
    if(ev.target.closest('.btn-open')){
      const r = getRowCache(id); const url = r && (r.panel_claim_url || vendorLinkFor(r));
      if(!url){ toast('URL panel tiada','warning'); return; }
      openOrReusePanel(url);
      return;
    }
    if(ev.target.closest('.btn-wa')){
      const url = ev.target.closest('.btn-wa').dataset.url; if(url) openOrReusePanel(url);
      return;
    }
    if(state.tab==='inprocess' && ev.target.closest('.btn-submit')){
      const r = getRowCache(id);
      const ref = prompt('Masukkan Claim Ref/ID (jika ada):', (r && r.claim_ref_id) || '');
      if(ref===null){ toast('Dibatalkan.','info'); return; }
      await updateStatus(id, { status_claim:'Submitted', claim_ref_id: ref });
      return;
    }
    if(state.tab==='submitted'){
      if(ev.target.closest('.btn-pending')){
        await updateStatus(id, { status_claim:'Submitted' });
        return;
      }
      if(ev.target.closest('.btn-done')){
        const r = getRowCache(id);
        const ref = prompt('Masukkan Claim Ref/ID (jika belum diisi):', (r && r.claim_ref_id) || '');
        if(ref===null){ toast('Dibatalkan.','info'); return; }
        await updateStatus(id, { status_claim:'Done', claim_ref_id: ref });
        return;
      }
      if(ev.target.closest('.btn-rejected')){
        const reason = prompt('Sebab Rejected (optional):','');
        if(reason===null){ toast('Dibatalkan.','info'); return; }
        await updateStatus(id, { status_claim:'Rejected', notes: reason||'' });
        return;
      }
    }
  });

  // simple row cache (updated in load)
  const _rowCache = new Map();
  function putRowCache(items){ _rowCache.clear(); items.forEach(r=> _rowCache.set(String(r.record_id), r)); }
  function getRowCache(id){ return _rowCache.get(String(id)); }
  function vendorLinkFor(r){
    const key = String(r.jenis_panel||'').toLowerCase().trim();
    const rp = regPanelMap.get(key);
    return rp && rp.panel_link ? rp.panel_link : '';
  }

  // ====== POST helper ======
  async function postJSON(action, obj){
    showLoading();
    try{
      const res = await fetch(API_BASE+'?action='+encodeURIComponent(action), { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(obj||{}) });
      const json = await res.json().catch(()=>null);
      if(!json || json.status!=='ok') throw new Error((json && json.message) || 'Request gagal');
      return json;
    } finally { hideLoading(); }
  }
  async function updateStatus(record_id, payload){
    try{
      const chip = tbody.querySelector('tr[data-id="'+CSS.escape(record_id)+'"] .chip');
      if(chip && payload.status_claim){
        chip.textContent = payload.status_claim;
        chip.className = 'chip ' + (payload.status_claim==='Rejected' ? 'rejected' : (payload.status_claim==='Done' ? 'done' : (payload.status_claim==='Submitted' ? 'submitted' : 'inprocess')));
      }
      await postJSON('updateclaimstatus', { record_id, ...payload });
      toast('Status dikemas kini','success');
      await load();
    }catch(e){ toast(e.message||'Gagal kemas status','error'); await load(); }
  }
  function updateBadgesApprox(items){
    putRowCache(items);
    const count={inprocess:0, submitted:0, done:0, rejected:0};
    items.forEach(r=>{
      const s=String(r.status_claim||'Not Started');
      if(s==='Done') count.done++; else if(s==='Rejected') count.rejected++; else if(s==='Submitted') count.submitted++; else count.inprocess++;
    });
    el('#badge-inprocess').textContent=String(count.inprocess);
    el('#badge-submitted').textContent=String(count.submitted);
    el('#badge-done').textContent=String(count.done);
    el('#badge-rejected').textContent=String(count.rejected);
  }

  // ====== REG PANEL LIST + INLINE EDIT ======
  async function loadRegPanel(){
    try{
      showLoading();
      const res = await fetch(API_BASE+'?action=listregpanel');
      const json = await res.json();
      if(json.status!=='ok') throw new Error(json.message||'Gagal memuat Reg Panel');
      const items = (json.data && (json.data.items || json.data)) || [];
      const tbodyRP = document.getElementById('rp_tbody');
      tbodyRP.innerHTML = items.map(p=> renderRegRow(p)).join('');
      tbodyRP.querySelectorAll('tr').forEach(tr => wireRegRow(tr));
      await buildRegPanelMap();
      await populatePanelDropdown();
    }catch(e){ console.error(e); toast('Ralat memuat Reg Panel','error'); }
    finally{ hideLoading(); }
  }

  function renderRegRow(p){
    const link = String(p.panel_link || p.login_url || p.claim_url_template || '');
    const waHref = p.pic_phone ? buildWAUrl(p.pic_phone, 'Hi '+(p.pic_name||'PIC')+' — pesanan dari klinik') : '';
    const terms = parseInt(p.payment_terms_days,10) || '';
    const safe = (x)=>escapeAttr(String(x||''));
    return (
      '<tr data-panel="'+safe(p.panel_name)+'">'+
        '<td class="magnifiable cell-name" data-title="Nama Panel" data-content="'+safe(p.panel_name)+'">'+
          '<span class="view">'+escapeHTML(p.panel_name||'')+'</span>'+
          '<input class="edit inline-input" style="display:none" value="'+safe(p.panel_name)+'" />'+
        '</td>'+
        '<td class="cell-link">'+
          '<span class="view"><a href="'+safe(link||'#')+'" target="_blank" rel="noopener">Buka</a></span>'+
          '<input class="edit inline-input" style="display:none" value="'+safe(link)+'" />'+
        '</td>'+
        '<td class="magnifiable cell-picname" data-title="Nama PIC" data-content="'+safe(p.pic_name)+'">'+
          '<span class="view">'+escapeHTML(p.pic_name||'')+'</span>'+
          '<input class="edit inline-input" style="display:none" value="'+safe(p.pic_name)+'" />'+
        '</td>'+
        '<td class="magnifiable cell-picphone" data-title="Telefon PIC" data-content="'+safe(p.pic_phone)+'">'+
          '<span class="view">'+escapeHTML(p.pic_phone||'')+'</span>'+
          '<input class="edit inline-input" style="display:none" value="'+safe(p.pic_phone)+'" />'+
        '</td>'+
        '<td class="cell-terms">'+
          '<span class="view">'+escapeHTML(String(terms))+'</span>'+
          '<input class="edit inline-input" style="display:none" type="number" min="1" step="1" value="'+safe(String(terms))+'" />'+
        '</td>'+
        '<td class="cell-notes">'+
          '<span class="view">'+escapeHTML(p.notes||'')+'</span>'+
          '<input class="edit inline-input" style="display:none" value="'+safe(p.notes)+'" />'+
        '</td>'+
        '<td>'+(waHref ? '<button class="wa btn-wa" type="button" data-url="'+safe(waHref)+'" title="WhatsApp PIC"><i class="fab fa-whatsapp"></i></button>' : '')+'</td>'+
        '<td class="actions">'+
          '<button class="btn-rp-edit secondary" type="button"><i class="fas fa-edit"></i></button>'+
          '<button class="btn-rp-del" type="button" style="background:#e74c3c;border-color:#e74c3c"><i class="fas fa-trash"></i></button>'+
          '<button class="btn-save" type="button" style="display:none"><i class="fas fa-save"></i></button>'+
          '<button class="btn-cancel secondary" type="button" style="display:none"><i class="fas fa-times"></i></button>'+
        '</td>'+
      '</tr>'
    );
  }

  function wireRegRow(tr){
    const btnEdit = tr.querySelector('.btn-rp-edit');
    const btnDel  = tr.querySelector('.btn-rp-del');
    const btnSave = tr.querySelector('.btn-save');
    const btnCancel=tr.querySelector('.btn-cancel');

    function setEditMode(on){
      tr.querySelectorAll('.view').forEach(e=> e.style.display = on ? 'none' : '');
      tr.querySelectorAll('.edit').forEach(e=> e.style.display = on ? '' : 'none');
      btnEdit.style.display = on ? 'none' : '';
      btnDel.style.display  = on ? 'none' : '';
      btnSave.style.display = on ? '' : 'none';
      btnCancel.style.display= on ? '' : 'none';
    }

    btnEdit.addEventListener('click', ()=> setEditMode(true));
    btnCancel.addEventListener('click', ()=> setEditMode(false));

    btnSave.addEventListener('click', async ()=>{
      const name = tr.getAttribute('data-panel'); // primary key (old name)
      const newName = tr.querySelector('.cell-name .edit').value.trim();
      const link = tr.querySelector('.cell-link .edit').value.trim();
      const picn = tr.querySelector('.cell-picname .edit').value.trim();
      const picp = tr.querySelector('.cell-picphone .edit').value.trim();
      const terms= parseInt(tr.querySelector('.cell-terms .edit').value,10);
      const notes= tr.querySelector('.cell-notes .edit').value.trim();
      if(!newName || !link || !Number.isFinite(terms) || terms<=0){ toast('Isi Nama, Link & Tempoh hari','warning'); return; }
      try{
        await postJSON('updateregpanel', { panel_name:newName, panel_link:link, pic_name:picn, pic_phone:picp, payment_terms_days:terms, notes });
        toast('Panel dikemas kini','success');
        await loadRegPanel();
      }catch(e){ toast('Gagal kemas panel','error'); }
    });

    btnDel.addEventListener('click', async ()=>{
      const name = tr.getAttribute('data-panel');
      if(!confirm('Padam panel "'+name+'"?')) return;
      try{ await postJSON('deleteregpanel',{panel_name:name}); toast('Panel dipadam','success'); await loadRegPanel(); }
      catch(e){ toast('Gagal padam panel','error'); }
    });

    // WhatsApp button (row-level)
    tr.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('.btn-wa'); if(!btn) return;
      const url = btn.dataset.url; if(url) openOrReusePanel(url);
    });
  }

  // Inline add panel
  async function saveRegPanel(){
    const name = el('#rp_name').value.trim();
    const link = el('#rp_link').value.trim();
    const picName = el('#rp_pic_name').value.trim();
    const picPhone = el('#rp_pic_phone').value.trim();
    const termsDays = parseInt(el('#rp_terms_days').value,10);
    const notes = el('#rp_notes').value.trim();
    if(!name || !link || !Number.isFinite(termsDays) || termsDays<=0){ toast('Sila isi Nama Panel, Link dan Tempoh (hari).','warning'); return; }
    try{
      await postJSON('updateregpanel', { panel_name:name, panel_link:link, pic_name:picName||'', pic_phone:picPhone||'', payment_terms_days:termsDays, notes:notes||'' });
      toast('Panel disimpan.','success');
      clearRegPanelForm();
      await loadRegPanel();
    }catch(e){ toast('Gagal simpan panel','error'); }
  }
  function clearRegPanelForm(){ ['#rp_name','#rp_link','#rp_pic_name','#rp_pic_phone','#rp_terms_days','#rp_notes'].forEach(id=> el(id).value=''); }

  // ====== Events ======
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));
  el('#search').addEventListener('input', e => { state.q = e.target.value.trim(); state.page=1; load(); });
  el('#filterPanelSelect').addEventListener('change', e => { state.filterPanelSelect = e.target.value; state.page=1; load(); });
  el('#filterPanelText').addEventListener('input', e => { state.filterPanelText = e.target.value.trim(); state.page=1; load(); });
  el('#filterSLA').addEventListener('change', e => { state.filterSLA = e.target.value; state.page=1; load(); });
  el('#sort').addEventListener('change', e => { state.sort = e.target.value; state.page=1; load(); });
  el('#pageSize').addEventListener('change', e => { state.pageSize = parseInt(e.target.value,10)||50; state.page=1; load(); });
  el('#refresh').addEventListener('click', load);
  el('#prev').addEventListener('click', ()=>{ if(state.page>1){ state.page--; load(); }});
  el('#next').addEventListener('click', ()=>{ state.page++; load(); });

  // Reg Panel buttons
  document.addEventListener('click', (ev)=>{
    if(ev.target && ev.target.id==='rp_save'){ saveRegPanel(); }
    if(ev.target && ev.target.id==='rp_clear'){ clearRegPanelForm(); toast('Bersih.','info'); }
  });

  // INIT
  setActiveTab('inprocess');
  </script>
</body>
</html>
