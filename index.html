<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Claims Portal</title>
  <style>
    :root{--bg:#f8f9fb;--fg:#111;--border:#e5e7eb;--soft:#f1f3f5;--brand:#111;--ok:#22c55e;--warn:#facc15;--bad:#ef4444;--wa:#25D366;}
    *{box-sizing:border-box}
    body{font-family:system-ui,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;background:var(--bg);color:var(--fg)}
    header{position:sticky;top:0;background:#fff;border-bottom:1px solid var(--border);z-index:10}
    .tabs{display:flex;gap:8px;align-items:center;padding:10px 16px;flex-wrap:wrap}
    .tab{padding:8px 12px;border-radius:10px;border:1px solid var(--border);background:#fff;cursor:pointer}
    .tab.active{background:var(--brand);color:#fff;border-color:var(--brand)}
    .badge{display:inline-block;min-width:18px;padding:0 6px;border-radius:999px;background:var(--brand);color:#fff;text-align:center;font-size:12px;margin-left:6px}
    .search{padding:12px 16px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    input[type="text"], input[type="url"], input[type="tel"], select, input[type="date"], textarea{padding:8px 10px;border:1px solid #d1d5db;border-radius:10px;min-width:170px;background:#fff}
    button{padding:8px 12px;border-radius:10px;border:1px solid var(--brand);background:var(--brand);color:#fff;cursor:pointer}
    button.secondary{background:#fff;color:var(--brand)} button[disabled]{opacity:.6;cursor:not-allowed}
    .container{display:grid;grid-template-columns:1fr}
    @media(min-width:1000px){.container{grid-template-columns:62% 38%}}
    .left{padding:16px} .right{padding:16px;border-left:1px solid var(--border);background:#fff;min-height:60vh}
    table{width:100%;border-collapse:collapse;background:#fff;border:1px solid var(--border)}
    th,td{border-bottom:1px solid var(--soft);padding:10px;text-align:left;font-size:14px;vertical-align:top}
    th{background:#fafafa;font-weight:600}
    .chip{display:inline-block;padding:2px 8px;border-radius:999px;font-size:12px;border:1px solid var(--border)}
    .chip.inprocess{background:#fffbe6;border-color:var(--warn)}
    .chip.done{background:#e6ffed;border-color:var(--ok)}
    .chip.rejected{background:#ffe6e6;border-color:var(--bad)}
    .actions{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .toast{position:fixed;right:16px;bottom:16px;background:#111;color:#fff;padding:10px 12px;border-radius:10px;opacity:0;transform:translateY(10px);transition:.2s}
    .toast.show{opacity:1;transform:translateY(0)}
    .price{font-size:12px;color:#333;line-height:1.3}
    .card{background:#fff;border:1px solid var(--border);border-radius:12px;padding:12px}
    /* Ikon WhatsApp rasmi */
    .wa{display:inline-flex;align-items:center;justify-content:center;width:34px;height:34px;border:1px solid var(--border);border-radius:999px;background:#fff;text-decoration:none}
    .wa .icon{width:18px;height:18px;display:block}
  </style>
</head>
<body>
  <header>
    <div class="tabs">
      <div class="tab active" data-tab="inprocess">Panel (In Process) <span id="badge-inprocess" class="badge">0</span></div>
      <div class="tab" data-tab="done">Panel (Done) <span id="badge-done" class="badge">0</span></div>
      <div class="tab" data-tab="rejected">Panel (Rejected) <span id="badge-rejected" class="badge">0</span></div>
      <div class="tab" data-tab="regpanel">Reg Panel</div>
    </div>
    <div class="search" id="searchBar">
      <input id="search" type="text" placeholder="Cari nama/IC..." />
      <select id="filterPanelSelect" title="Tapis Jenis Panel"><option value="">Semua Panel</option></select>
      <input id="filterPanelText" type="text" placeholder="Tulis nama panel..." />
      <select id="sort">
        <option value="tarikh_desc">Tarikh Hadir: Terbaru</option>
        <option value="tarikh_asc">Tarikh Hadir: Terdahulu</option>
        <option value="panel_az">Jenis Panel: A → Z</option>
        <option value="panel_za">Jenis Panel: Z → A</option>
        <option value="nama_az">Nama Pesakit: A → Z</option>
        <option value="nama_za">Nama Pesakit: Z → A</option>
      </select>
      <select id="pageSize" title="Rekod per halaman"><option>25</option><option selected>50</option><option>100</option></select>
      <button id="refresh" class="secondary" title="Muat semula">Refresh</button>
    </div>
  </header>

  <div class="container">
    <section class="left">
      <div id="recordsView">
        <table>
          <thead>
            <tr>
              <th>Nama</th>
              <th>IC</th>
              <th>Telefon</th>
              <th>Tarikh Hadir</th>
              <th>Panel / PIC</th>
              <th>Harga</th>
              <th>Ubat</th>
              <th>Status</th>
              <th>Tindakan</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
        <div class="actions" style="margin-top:12px">
          <button id="prev" class="secondary">Prev</button>
          <span id="pageInfo"></span>
          <button id="next" class="secondary">Next</button>
        </div>
      </div>

      <div id="regPanelView" style="display:none">
        <div class="card" style="margin-bottom:12px">
          <h3 style="margin:0 0 8px 0">Daftar Panel Baharu</h3>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px">
            <div><label>Nama Panel *</label><input id="rp_name" type="text" placeholder="Contoh: Panel Contoso" required /></div>
            <div><label>Link Panel (URL) *</label><input id="rp_link" type="url" placeholder="https://..." required /></div>
            <div><label>Nama PIC</label><input id="rp_pic_name" type="text" placeholder="Contoh: En. Ahmad" /></div>
            <div><label>No. Telefon PIC</label><input id="rp_pic_phone" type="tel" placeholder="0123456789" /></div>
            <div><label>Term Pembayaran</label><input id="rp_terms" type="text" placeholder="Contoh: 30 hari" /></div>
            <div style="grid-column:1 / -1"><label>Catatan</label><textarea id="rp_notes" placeholder="Nota tambahan jika perlu" style="width:100%"></textarea></div>
          </div>
          <div style="margin-top:10px;display:flex;gap:8px">
            <button id="rp_save">Simpan Panel</button>
            <button id="rp_clear" class="secondary">Clear</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px 0">Senarai Panel Berdaftar</h3>
          <table>
            <thead>
              <tr>
                <th>Nama</th>
                <th>Link</th>
                <th>PIC</th>
                <th>Term</th>
                <th>WhatsApp</th>
              </tr>
            </thead>
            <tbody id="rp_tbody"></tbody>
          </table>
        </div>
      </div>
    </section>

    <aside class="right">
      <h3>Panel Window</h3>
      <p class="hint">Klik <b>Open</b> atau ikon <b>WhatsApp</b>. Satu popup di kanan akan digunakan semula (URL sama → fokus).</p>
      <div id="detail"></div>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
  // ===== KONFIG =====
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzkhLra1C5rg2HWY2oc3LlkLmBbKTtTbqThN7P0kpqC7z4b6yfMRJLXm4BBLkPzSko/exec';

  // ===== STATE =====
  let state = { tab:'inprocess', page:1, pageSize:50, q:'', sort:'tarikh_desc', filterPanelSelect:'', filterPanelText:'' };
  let regPanelMap = new Map();
  let lastClickAt = 0;

  // ===== HELPERS =====
  const el = s => document.querySelector(s);
  const tbody = el('#tbody');
  const pageInfo = el('#pageInfo');
  const toastEl = el('#toast');
  const escapeHtml = s => String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  function toast(m){ toastEl.textContent=m; toastEl.classList.add('show'); setTimeout(()=>toastEl.classList.remove('show'),2200); }

  function formatDateDDMMYYYY_HHMM(v){
    if(!v) return '';
    let d;
    if(v instanceof Date) d=v; else {
      const s=String(v);
      if(/^\d{4}-\d{2}-\d{2}$/.test(s)) d=new Date(s+'T00:00:00'); else d=new Date(s);
      if(isNaN(d.getTime())) return escapeHtml(s);
    }
    const p=n=>String(n).padStart(2,'0');
    return `${p(d.getDate())}/${p(d.getMonth()+1)}/${d.getFullYear()} ${p(d.getHours())}:${p(d.getMinutes())}`;
  }

  // ===== SATU POPUP DI KANAN (REUSE) =====
  const POPUP_NAME = 'panel_claim_popup_right';
  function openOrReuseRight(url) {
    const now = Date.now();
    if (now - lastClickAt < 400) return; // debounce
    lastClickAt = now;
    url = String(url||'');

    // Cuba attach pada popup sedia ada
    let w = null;
    try{
      w = window.open('', POPUP_NAME);
      if (w && !w.closed) {
        try {
          const current = w.location && String(w.location.href);
          if (current === url) { w.focus(); return; }
        } catch(e) {}
        w.location.href = url; w.focus(); return;
      }
    }catch(e){}

    // Cipta popup baru di kanan
    const sw = window.screen.availWidth, sh = window.screen.availHeight;
    const width  = Math.max(520, Math.round(sw*0.34));
    const height = Math.max(650, sh);
    const left   = Math.max(0, sw - width);
    const top    = 0;
    const features = [
      'popup=yes','toolbar=no','location=no','status=no','menubar=no',
      'scrollbars=yes','resizable=yes',
      `width=${width}`, `height=${height}`, `left=${left}`, `top=${top}`
    ].join(',');
    const created = window.open(url, POPUP_NAME, features);
    if (!created) {
      alert('Sila benarkan pop-up untuk domain ini.');
      window.open(url, POPUP_NAME); // fallback (tab) masih reuse nama sama
      return;
    }
    created.focus();
  }

  // ===== DATA HELPERS =====
  const toDigits = s => String(s||'').replace(/[^\d]/g,'');
  function buildWAUrl(phone, text){
    const p = toDigits(phone); const q = encodeURIComponent(text||'');
    if(!p) return '';
    return `https://web.whatsapp.com/send?phone=${p}${q?`&text=${q}`:''}`;
  }
  const waSVG = `
  <svg class="icon" viewBox="0 0 32 32" aria-hidden="true" focusable="false">
    <circle cx="16" cy="16" r="16" fill="#25D366"/>
    <path fill="#fff" d="M21.6 17.4c-.2-.1-1.2-.6-1.4-.7s-.3-.1-.5.1-.5.6-.6.7-.2.2-.4.1c-.2-.1-.8-.3-1.5-1-.6-.5-1-.9-1.1-1.1-.1-.2 0-.3.1-.4.1-.1.2-.3.3-.4.1-.1.1-.2.2-.3.1-.1 0-.3 0-.4s-.5-1.3-.7-1.8c-.2-.5-.4-.4-.5-.4h-.4c-.1 0-.4.1-.6.3-.2.2-.8.7-.8 1.8s.9 2 1 2.2c.1.2 1.7 2.3 3.9 3.3.6.2 1 .4 1.3.5.5.2 1.1.2 1.5.1.4-.1 1.3-.6 1.5-1.1.2-.5.2-1 .1-1.1s-.2-.1-.4-.2zM16 6.1c-4.5 0-8.1 3.5-8.1 7.9 0 1.6.5 3.1 1.4 4.3l-1 3.6 3.7-1c1.2.7 2.7 1.1 4.3 1.1 4.5 0 8.1-3.5 8.1-7.9S20.5 6.1 16 6.1z"/>
  </svg>`;

  // ===== TABS =====
  function setActiveTab(tab){
    state.tab = tab;
    document.querySelectorAll('.tab').forEach(t=> t.classList.toggle('active', t.dataset.tab===tab));
    const isReg = tab==='regpanel';
    el('#recordsView').style.display = isReg ? 'none' : '';
    el('#regPanelView').style.display = isReg ? '' : 'none';
    el('#searchBar').style.display   = isReg ? 'none' : '';
    if(isReg){ loadRegPanel(); } else { state.page=1; load(); }
  }

  // ===== LOAD RECORDS =====
  async function load(){
    if(regPanelMap.size===0){ await buildRegPanelMap(); await populatePanelDropdown(); }
    const url = `${API_BASE}?action=listrecords&statusTab=${encodeURIComponent(state.tab)}&page=${state.page}&pageSize=${state.pageSize}&q=${encodeURIComponent(state.q)}`;
    try{
      const res = await fetch(url); const json = await res.json();
      if(json.status!=='ok') throw new Error(json.message||'Gagal memuat data');
      const {items} = json.data;

      // Filter panel: dropdown exact + teks contains (AND jika dua-dua ada)
      let filtered = items.slice();
      if(state.filterPanelSelect){
        const key = state.filterPanelSelect.toLowerCase();
        filtered = filtered.filter(r => String(r.jenis_panel||'').toLowerCase() === key);
      }
      if(state.filterPanelText){
        const t = state.filterPanelText.toLowerCase();
        filtered = filtered.filter(r => String(r.jenis_panel||'').toLowerCase().includes(t));
      }

      const sorted = sortItems(filtered);
      renderTable(sorted);
      updateBadgesApprox(sorted);
    }catch(e){ console.error(e); toast('Ralat memuat data'); }
  }

  function parseDate(v){ if(!v) return null; const s=String(v); if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s+'T00:00:00'); const d=new Date(s); return isNaN(d)?null:d; }
  function sortItems(items){
    const m = state.sort;
    if(m==='panel_az' || m==='panel_za'){
      items.sort((a,b)=> String(a.jenis_panel||'').localeCompare(String(b.jenis_panel||''),'ms',{sensitivity:'base'}));
      if(m==='panel_za') items.reverse(); return items;
    }
    if(m==='nama_az' || m==='nama_za'){
      items.sort((a,b)=> String(a.nama_pesakit||'').localeCompare(String(b.nama_pesakit||''),'ms',{sensitivity:'base'}));
      if(m==='nama_za') items.reverse(); return items;
    }
    items.sort((a,b)=>{
      const ta=(parseDate(a.tarikh_hadir)||0).getTime?.()||0;
      const tb=(parseDate(b.tarikh_hadir)||0).getTime?.()||0;
      return tb - ta; // terbaru dulu
    });
    if(m==='tarikh_asc') items.reverse();
    return items;
  }

  function renderTable(items){
    pageInfo.textContent = `Halaman ${state.page} • ${items.length} rekod`;
    tbody.innerHTML = items.map(r => renderRow(r)).join('');
    items.forEach(r => wireRow(r));
  }

  function num(x){ const n=parseFloat(String(x||'').replace(/[^\d.]/g,''))||0; return n.toFixed(2); }

  function renderRow(r){
    const status = (r.status_claim||'Not Started');
    const cls = status==='Done'||status==='Submitted' ? 'done' : (status==='Rejected' ? 'rejected' : 'inprocess');

    const key = String(r.jenis_panel||'').toLowerCase().trim();
    const reg = regPanelMap.get(key);

    const waPatientURL = r.no_telefon ? buildWAUrl(r.no_telefon, `Assalamualaikum/Hi ${r.nama_pesakit||''}`) : '';
    const waPatientIcon = waPatientURL ? `
      <a class="wa" href="javascript:void(0)" aria-label="WhatsApp Pesakit" title="WhatsApp Pesakit"
         onclick="openOrReuseRight('${waPatientURL.replace(/'/g,'%27')}')">${waSVG}</a>` : '';

    const waPICURL = (reg && reg.pic_phone) ? buildWAUrl(reg.pic_phone, `Hi ${reg.pic_name||'PIC'}, rujukan tuntutan: ${r.record_id||''}`) : '';
    const waPICIcon = waPICURL ? `
      <a class="wa" href="javascript:void(0)" aria-label="WhatsApp PIC Panel" title="WhatsApp PIC Panel"
         onclick="openOrReuseRight('${waPICURL.replace(/'/g,'%27')}')">${waSVG}</a>` : '';

    const price = `<div class="price">
      Consult RM${num(r.harga_consultation)} · Ubat RM${num(r.harga_ubat)} · Prosedur RM${num(r.harga_prosedur)}<br>
      <b>Jumlah RM${num(r.harga_jumlah)}</b>
    </div>`;

    return `<tr data-id="${escapeHtml(r.record_id)}">
      <td>${escapeHtml(r.nama_pesakit||'')}</td>
      <td>${escapeHtml(r.no_ic||'')}</td>
      <td><div style="display:flex;align-items:center;gap:8px"><span>${escapeHtml(r.no_telefon||'')}</span>${waPatientIcon||''}</div></td>
      <td>${formatDateDDMMYYYY_HHMM(r.tarikh_hadir)}</td>
      <td>
        <div><b>${escapeHtml(r.jenis_panel||'')}</b></div>
        ${reg ? `<div class="price" style="margin-top:4px">
          ${escapeHtml(reg.pic_name||'-')}<br>
          <div style="display:flex;align-items:center;gap:8px">
            <small>${escapeHtml(reg.pic_phone||'')}</small>${waPICIcon||''}
          </div>
        </div>` : ''}
      </td>
      <td>${price}</td>
      <td>${escapeHtml(r.jenis_ubat||'')}</td>
      <td><span class="chip ${cls}">${escapeHtml(status)}</span></td>
      <td class="actions">
        <button class="secondary btn-open" title="Buka laman panel">Open</button>
        <button class="btn-submit" title="Tanda Submitted">Submit</button>
      </td>
    </tr>`;
  }

  function wireRow(r){
    const tr = tbody.querySelector(`tr[data-id="${CSS.escape(String(r.record_id))}"]`);
    const openBtn = tr.querySelector('.btn-open');
    openBtn.addEventListener('click', ()=>{
      openBtn.disabled = true;
      const url = r.panel_claim_url || '';
      if(!url){ toast('URL panel tiada'); openBtn.disabled=false; return; }
      openOrReuseRight(url);
      setTimeout(()=> openBtn.disabled=false, 500);
    });

    const submitBtn = tr.querySelector('.btn-submit');
    if(submitBtn){
      submitBtn.addEventListener('click', async ()=>{
        const ref = prompt('Masukkan Claim Ref/ID (jika ada):', r.claim_ref_id||'');
        await updateStatus(r.record_id, { status_claim: 'Submitted', claim_ref_id: ref });
      });
    }
  }

  // ===== POST util (kurang preflight) =====
  async function postForm(action, obj){
    const body = new URLSearchParams(); body.set('payload', JSON.stringify(obj||{}));
    const res = await fetch(`${API_BASE}?action=${encodeURIComponent(action)}`, { method:'POST', body });
    const json = await res.json().catch(()=>null);
    if(!json || json.status!=='ok') throw new Error((json && json.message) || 'Request gagal');
    return json;
  }
  async function updateStatus(record_id, payload){
    try{
      const tr = tbody.querySelector(`tr[data-id="${CSS.escape(String(record_id))}"]`);
      if(tr){ const chip=tr.querySelector('.chip'); chip.textContent='Submitted'; chip.className='chip done'; }
      await postForm('updateclaimstatus', { record_id, ...payload });
      toast('Status dikemas kini');
    }catch(e){ toast(e.message||'Gagal kemas status'); await load(); }
  }

  function updateBadgesApprox(items){
    const count={inprocess:0, done:0, rejected:0};
    items.forEach(r=>{ const s=(r.status_claim||'Not Started'); if(s==='Done'||s==='Submitted') count.done++; else if(s==='Rejected') count.rejected++; else count.inprocess++; });
    document.getElementById('badge-inprocess').textContent=String(count.inprocess);
    document.getElementById('badge-done').textContent=String(count.done);
    document.getElementById('badge-rejected').textContent=String(count.rejected);
  }

  // ===== REG PANEL =====
  async function buildRegPanelMap(){
    regPanelMap.clear();
    try{
      const res = await fetch(`${API_BASE}?action=listregpanel`);
      const json = await res.json();
      if(json.status!=='ok') return;
      const items = json.data.items || [];
      for(const p of items){
        const key = String(p.panel_name||'').toLowerCase().trim();
        regPanelMap.set(key, { pic_name: p.pic_name||'', pic_phone: p.pic_phone||'', panel_link: p.panel_link||'', payment_terms: p.payment_terms||'' });
      }
    }catch(e){ console.warn('Gagal muat Reg Panel map', e); }
  }
  async function populatePanelDropdown(){
    const select = el('#filterPanelSelect');
    select.innerHTML = '<option value="">Semua Panel</option>';
    const names = Array.from(regPanelMap.keys()).sort((a,b)=> a.localeCompare(b,'ms',{sensitivity:'base'}));
    for(const name of names){
      const opt = document.createElement('option');
      opt.value = name; opt.textContent = name.replace(/\b\w/g, c=>c.toUpperCase());
      select.appendChild(opt);
    }
  }
  async function loadRegPanel(){
    try{
      const res = await fetch(`${API_BASE}?action=listregpanel`);
      const json = await res.json();
      if(json.status!=='ok') throw new Error(json.message||'Gagal memuat Reg Panel');
      const items = json.data.items || [];
      document.getElementById('rp_tbody').innerHTML = items.map(p => {
        const href = p.pic_phone ? buildWAUrl(p.pic_phone, `Hi ${p.pic_name||'PIC'} — pesanan dari klinik`) : '';
        const waBtn = href ? `<a class="wa" href="javascript:void(0)" onclick="openOrReuseRight('${href.replace(/'/g,"%27")}')" title="WhatsApp PIC">${waSVG}</a>` : '';
        return `<tr>
          <td>${escapeHtml(p.panel_name||'')}</td>
          <td><a href="${escapeHtml(p.panel_link||'#')}" target="_blank" rel="noopener">Buka</a></td>
          <td>${escapeHtml(p.pic_name||'')}<br><small>${escapeHtml(p.pic_phone||'')}</small></td>
          <td>${escapeHtml(p.payment_terms||'')}</td>
          <td>${waBtn}</td>
        </tr>`;
      }).join('');
      await buildRegPanelMap();
      await populatePanelDropdown();
    }catch(e){ console.error(e); toast('Ralat memuat Reg Panel'); }
  }

  // ===== EVENTS =====
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', ()=> setActiveTab(t.dataset.tab)));
  document.getElementById('search').addEventListener('input', e => { state.q = e.target.value.trim(); state.page=1; load(); });
  document.getElementById('filterPanelSelect').addEventListener('change', e => { state.filterPanelSelect = e.target.value; state.page=1; load(); });
  document.getElementById('filterPanelText').addEventListener('input', e => { state.filterPanelText = e.target.value.trim(); state.page=1; load(); });
  document.getElementById('sort').addEventListener('change', e => { state.sort = e.target.value; state.page=1; load(); });
  document.getElementById('pageSize').addEventListener('change', e => { state.pageSize = parseInt(e.target.value,10)||50; state.page=1; load(); });
  document.getElementById('refresh').addEventListener('click', load);
  document.getElementById('prev').addEventListener('click', ()=>{ if(state.page>1){ state.page--; load(); }});
  document.getElementById('next').addEventListener('click', ()=>{ state.page++; load(); });

  // INIT
  setActiveTab('inprocess'); // akan panggil load()
  </script>
</body>
</html>
