<!DOCTYPE html>
<html lang="ms">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Panel Claims Portal</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8f9fb;
      --fg: #111;
      --muted: #555;
      --border: #e5e7eb;
      --soft: #f1f3f5;
      --brand: #2563eb;
      --brand-light: #3b82f6;
      --brand-dark: #1e40af;
      --ok: #22c55e;
      --warn: #facc15;
      --bad: #ef4444;
      --wa: #25D366;
      --card-shadow: 0 2px 8px rgba(0,0,0,0.08);
      --hover-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      font-family: 'Segoe UI', system-ui, -apple-system, Roboto, sans-serif;
      margin: 0;
      background: var(--bg);
      color: var(--fg);
      line-height: 1.5;
    }
    
    /* Header & Navigation */
    header {
      position: sticky;
      top: 0;
      background: #fff;
      border-bottom: 1px solid var(--border);
      z-index: 10;
      box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }
    
    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid var(--soft);
    }
    
    .logo {
      display: flex;
      align-items: center;
      gap: 10px;
      font-weight: 600;
      font-size: 18px;
    }
    
    .logo i {
      color: var(--brand);
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      font-size: 14px;
    }
    
    .user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      background: var(--brand);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
    }
    
    .tabs {
      display: flex;
      gap: 4px;
      align-items: center;
      padding: 10px 16px;
      flex-wrap: wrap;
    }
    
    .tab {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--border);
      background: #fff;
      cursor: pointer;
      transition: all 0.2s;
      font-size: 14px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    
    .tab:hover {
      background: #f8fafc;
      border-color: var(--brand-light);
    }
    
    .tab.active {
      background: var(--brand);
      color: #fff;
      border-color: var(--brand);
    }
    
    .badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 20px;
      height: 20px;
      padding: 0 6px;
      border-radius: 999px;
      background: rgba(255,255,255,0.9);
      color: var(--brand);
      text-align: center;
      font-size: 12px;
      font-weight: 600;
    }
    
    .tab.active .badge {
      background: rgba(255,255,255,0.2);
      color: #fff;
    }
    
    /* Search & Filters */
    .search {
      padding: 16px;
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items: center;
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
    }
    
    .filter-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .filter-group label {
      font-size: 13px;
      color: var(--muted);
      white-space: nowrap;
    }
    
    input[type="text"], input[type="url"], input[type="tel"], select, input[type="date"], textarea {
      padding: 8px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      min-width: 150px;
      background: #fff;
      font-size: 14px;
      transition: border-color 0.2s;
    }
    
    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--brand);
      box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
    }
    
    button {
      padding: 8px 16px;
      border-radius: 8px;
      border: 1px solid var(--brand);
      background: var(--brand);
      color: #fff;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    
    button:hover {
      background: var(--brand-dark);
      border-color: var(--brand-dark);
      transform: translateY(-1px);
    }
    
    button.secondary {
      background: #fff;
      color: var(--brand);
    }
    
    button.secondary:hover {
      background: #f1f5f9;
    }
    
    button[disabled] {
      opacity: .5;
      cursor: not-allowed;
      transform: none;
    }
    
    /* Main Layout */
    .container {
      display: grid;
      grid-template-columns: 1fr;
      min-height: calc(100vh - 150px);
    }
    
    @media(min-width: 1200px) {
      .container {
        grid-template-columns: 65% 35%;
      }
    }
    
    .left {
      padding: 20px;
    }
    
    .right {
      padding: 20px;
      border-left: 1px solid var(--border);
      background: #fff;
      min-height: 60vh;
    }
    
    /* Table Styling */
    .table-container {
      background: #fff;
      border-radius: 12px;
      border: 1px solid var(--border);
      overflow: hidden;
      box-shadow: var(--card-shadow);
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    
    th, td {
      border-bottom: 1px solid var(--soft);
      padding: 12px 16px;
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }
    
    th {
      background: #f8fafc;
      font-weight: 600;
      color: var(--muted);
      position: sticky;
      top: 0;
      z-index: 1;
    }
    
    tr:hover {
      background: #f8fafc;
    }
    
    .chip {
      display: inline-flex;
      align-items: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border);
      white-space: nowrap;
    }
    
    .chip.inprocess {
      background: #fffbe6;
      border-color: var(--warn);
      color: #b45309;
    }
    
    .chip.done {
      background: #e6ffed;
      border-color: var(--ok);
      color: #065f46;
    }
    
    .chip.rejected {
      background: #ffe6e6;
      border-color: var(--bad);
      color: #991b1b;
    }
    
    .sla {
      display: inline-flex;
      align-items: center;
      border-radius: 999px;
      padding: 4px 10px;
      font-size: 12px;
      font-weight: 500;
      border: 1px solid var(--border);
      margin-left: 6px;
    }
    
    .sla.on {
      background: #e6ffed;
      border-color: var(--ok);
      color: #065f46;
    }
    
    .sla.today {
      background: #fffbe6;
      border-color: var(--warn);
      color: #b45309;
    }
    
    .sla.over {
      background: #ffe6e6;
      border-color: var(--bad);
      color: #991b1b;
    }
    
    .actions {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .price {
      font-size: 12px;
      color: #333;
      line-height: 1.3;
    }
    
    /* Cards */
    .card {
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 16px;
      box-shadow: var(--card-shadow);
      margin-bottom: 16px;
    }
    
    .card h3 {
      margin: 0 0 12px 0;
      font-size: 18px;
      font-weight: 600;
      color: var(--fg);
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .card h3 i {
      color: var(--brand);
    }
    
    /* WhatsApp Button */
    .wa {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 32px;
      height: 32px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: #fff;
      color: var(--wa);
      text-decoration: none;
      transition: all 0.2s;
    }
    
    .wa:hover {
      background: #f4fff8;
      transform: scale(1.05);
    }
    
    .wa .icon {
      width: 16px;
      height: 16px;
      display: block;
    }
    
    .label-mini {
      font-size: 11px;
      color: #333;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 2px 6px;
      margin-left: 6px;
    }
    
    /* Button Variants */
    .btn-danger {
      border-color: var(--bad);
      background: var(--bad);
    }
    
    .btn-danger:hover {
      background: #dc2626;
      border-color: #dc2626;
    }
    
    .btn-warning {
      border-color: var(--warn);
      background: var(--warn);
      color: #111;
    }
    
    .btn-warning:hover {
      background: #eab308;
      border-color: #eab308;
    }
    
    .btn-success {
      border-color: var(--ok);
      background: var(--ok);
    }
    
    .btn-success:hover {
      background: #16a34a;
      border-color: #16a34a;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      right: 16px;
      bottom: 16px;
      background: #111;
      color: #fff;
      padding: 12px 16px;
      border-radius: 8px;
      opacity: 0;
      transform: translateY(10px);
      transition: .2s;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    .toast i {
      font-size: 18px;
    }
    
    .toast.success i {
      color: var(--ok);
    }
    
    .toast.error i {
      color: var(--bad);
    }
    
    .toast.warning i {
      color: var(--warn);
    }
    
    /* Pagination */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding: 12px 16px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 8px;
      box-shadow: var(--card-shadow);
    }
    
    .pagination-info {
      font-size: 14px;
      color: var(--muted);
    }
    
    .pagination-controls {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    /* Stats Cards */
    .stats-container {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 20px;
    }
    
    .stat-card {
      background: #fff;
      border-radius: 12px;
      padding: 16px;
      border: 1px solid var(--border);
      box-shadow: var(--card-shadow);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: var(--brand);
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--muted);
    }
    
    .stat-card.inprocess { border-left: 4px solid var(--warn); }
    .stat-card.submitted { border-left: 4px solid var(--brand); }
    .stat-card.done { border-left: 4px solid var(--ok); }
    .stat-card.rejected { border-left: 4px solid var(--bad); }
    
    /* Form Improvements */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    
    @media(min-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr 1fr;
      }
    }
    
    .form-field {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }
    
    .form-field label {
      font-size: 14px;
      font-weight: 500;
      color: var(--muted);
    }
    
    .form-field.full-width {
      grid-column: 1 / -1;
    }
    
    /* Loading Spinner */
    .spinner {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 2px solid rgba(255,255,255,0.3);
      border-radius: 50%;
      border-top-color: #fff;
      animation: spin 1s ease-in-out infinite;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* Responsive Improvements */
    @media (max-width: 768px) {
      .tabs {
        justify-content: center;
      }
      
      .search {
        flex-direction: column;
        align-items: stretch;
      }
      
      .filter-group {
        justify-content: space-between;
      }
      
      .table-container {
        overflow-x: auto;
      }
      
      table {
        min-width: 800px;
      }
    }
    
    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--muted);
    }
    
    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <header>
    <div class="header-top">
      <div class="logo">
        <i class="fas fa-file-invoice-dollar"></i>
        <span>Panel Claims Portal</span>
      </div>
      <div class="user-info">
        <span>Selamat datang, <strong>Admin</strong></span>
        <div class="user-avatar">A</div>
      </div>
    </div>
    
    <div class="tabs">
      <div class="tab active" data-tab="inprocess">
        <i class="fas fa-clock"></i>
        <span>Panel (In Process)</span>
        <span id="badge-inprocess" class="badge">0</span>
      </div>
      <div class="tab" data-tab="submitted">
        <i class="fas fa-paper-plane"></i>
        <span>Panel (Submitted)</span>
        <span id="badge-submitted" class="badge">0</span>
      </div>
      <div class="tab" data-tab="done">
        <i class="fas fa-check-circle"></i>
        <span>Panel (Done)</span>
        <span id="badge-done" class="badge">0</span>
      </div>
      <div class="tab" data-tab="rejected">
        <i class="fas fa-times-circle"></i>
        <span>Panel (Rejected)</span>
        <span id="badge-rejected" class="badge">0</span>
      </div>
      <div class="tab" data-tab="regpanel">
        <i class="fas fa-cog"></i>
        <span>Reg Panel</span>
      </div>
    </div>
    
    <div class="search" id="searchBar">
      <div class="filter-group">
        <label for="search"><i class="fas fa-search"></i> Cari:</label>
        <input id="search" type="text" placeholder="Nama/IC..." />
      </div>
      
      <div class="filter-group">
        <label for="filterPanelSelect">Panel:</label>
        <select id="filterPanelSelect" title="Tapis Jenis Panel">
          <option value="">Semua Panel</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filterPanelText">Nama Panel:</label>
        <input id="filterPanelText" type="text" placeholder="Tulis nama panel..." />
      </div>
      
      <div class="filter-group">
        <label for="sort">Susunan:</label>
        <select id="sort">
          <option value="tarikh_desc">Tarikh Hadir: Terbaru</option>
          <option value="tarikh_asc">Tarikh Hadir: Terdahulu</option>
          <option value="panel_az">Jenis Panel: A → Z</option>
          <option value="panel_za">Jenis Panel: Z → A</option>
          <option value="nama_az">Nama Pesakit: A → Z</option>
          <option value="nama_za">Nama Pesakit: Z → A</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="filterSLA">SLA:</label>
        <select id="filterSLA" title="Status SLA">
          <option value="">Semua</option>
          <option value="over">Overdue</option>
          <option value="today">Due Today</option>
          <option value="on">On Track</option>
        </select>
      </div>
      
      <div class="filter-group">
        <label for="pageSize">Rekod:</label>
        <select id="pageSize" title="Rekod per halaman">
          <option>25</option>
          <option selected>50</option>
          <option>100</option>
        </select>
      </div>
      
      <button id="refresh" class="secondary" title="Muat semula">
        <i class="fas fa-sync-alt"></i> Refresh
      </button>
    </div>
  </header>

  <div class="container">
    <section class="left">
      <!-- Stats Overview -->
      <div class="stats-container" id="statsContainer">
        <div class="stat-card inprocess">
          <div class="stat-value" id="stat-inprocess">0</div>
          <div class="stat-label">In Process</div>
        </div>
        <div class="stat-card submitted">
          <div class="stat-value" id="stat-submitted">0</div>
          <div class="stat-label">Submitted</div>
        </div>
        <div class="stat-card done">
          <div class="stat-value" id="stat-done">0</div>
          <div class="stat-label">Done</div>
        </div>
        <div class="stat-card rejected">
          <div class="stat-value" id="stat-rejected">0</div>
          <div class="stat-label">Rejected</div>
        </div>
      </div>
      
      <div id="recordsView">
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Nama</th>
                <th>IC</th>
                <th>Telefon</th>
                <th>Tarikh Hadir</th>
                <th>Panel / PIC</th>
                <th>Harga</th>
                <th>Ubat</th>
                <th>Status</th>
                <th>Tindakan</th>
              </tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        
        <div class="pagination">
          <div class="pagination-info" id="pageInfo"></div>
          <div class="pagination-controls">
            <button id="prev" class="secondary">
              <i class="fas fa-chevron-left"></i> Prev
            </button>
            <button id="next" class="secondary">
              Next <i class="fas fa-chevron-right"></i>
            </button>
          </div>
        </div>
      </div>

      <div id="regPanelView" style="display:none">
        <div class="card" style="margin-bottom:16px">
          <h3><i class="fas fa-plus-circle"></i> Daftar / Edit Panel</h3>
          <div class="form-grid">
            <div class="form-field">
              <label for="rp_name">Nama Panel *</label>
              <input id="rp_name" type="text" placeholder="Contoh: AIA" required />
            </div>
            <div class="form-field">
              <label for="rp_link">Link Panel (URL) *</label>
              <input id="rp_link" type="url" placeholder="https://..." required />
            </div>
            <div class="form-field">
              <label for="rp_pic_name">Nama PIC</label>
              <input id="rp_pic_name" type="text" placeholder="Contoh: En. Ahmad" />
            </div>
            <div class="form-field">
              <label for="rp_pic_phone">No. Telefon PIC</label>
              <input id="rp_pic_phone" type="tel" placeholder="0123456789" />
            </div>
            <div class="form-field">
              <label for="rp_terms_days">Tempoh (hari) *</label>
              <input id="rp_terms_days" type="number" min="1" step="1" placeholder="cth: 30" />
            </div>
            <div class="form-field full-width">
              <label for="rp_notes">Catatan</label>
              <textarea id="rp_notes" placeholder="Nota tambahan jika perlu" rows="3"></textarea>
            </div>
          </div>
          <div style="margin-top:16px;display:flex;gap:8px">
            <button id="rp_save" class="btn-success">
              <i class="fas fa-save"></i> Simpan Panel
            </button>
            <button id="rp_clear" class="secondary">
              <i class="fas fa-broom"></i> Clear
            </button>
          </div>
        </div>

        <div class="card">
          <h3><i class="fas fa-list"></i> Senarai Panel Berdaftar</h3>
          <div class="table-container">
            <table>
              <thead>
                <tr>
                  <th>Nama</th>
                  <th>Link</th>
                  <th>PIC</th>
                  <th>Tempoh (hari)</th>
                  <th>WhatsApp</th>
                  <th>Tindakan</th>
                </tr>
              </thead>
              <tbody id="rp_tbody"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>

    <aside class="right">
      <div class="card">
        <h3><i class="fas fa-external-link-alt"></i> Panel Window</h3>
        <p style="font-size:14px; color:var(--muted); margin-bottom:16px;">
          Klik <b>Open</b> atau ikon <b>WhatsApp</b>. Tetingkap kanan dibuka sekali & dikitar semula.
        </p>
        <div id="detail">
          <div class="empty-state">
            <i class="fas fa-mouse-pointer"></i>
            <p>Pilih rekod untuk melihat butiran</p>
          </div>
        </div>
      </div>
      
      <!-- Quick Actions Card -->
      <div class="card">
        <h3><i class="fas fa-bolt"></i> Tindakan Pantas</h3>
        <div style="display:flex; flex-direction:column; gap:10px;">
          <button class="secondary" id="quickNewClaim">
            <i class="fas fa-plus"></i> Tuntutan Baru
          </button>
          <button class="secondary" id="quickExport">
            <i class="fas fa-file-export"></i> Eksport Data
          </button>
          <button class="secondary" id="quickReports">
            <i class="fas fa-chart-bar"></i> Laporan
          </button>
        </div>
      </div>
    </aside>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite">
    <i class="fas fa-check-circle"></i>
    <span></span>
  </div>

  <script>
  // ===== CONFIG =====
  const API_BASE = 'https://script.google.com/macros/s/AKfycbzkhLra1C5rg2HWY2oc3LlkLmBbKTtTbqThN7P0kpqC7z4b6yfMRJLXm4BBLkPzSko/exec';

  // ===== STATE =====
  let state = { 
    tab: 'inprocess', 
    page: 1, 
    pageSize: 50, 
    q: '', 
    sort: 'tarikh_desc', 
    filterPanelSelect: '', 
    filterPanelText: '', 
    filterSLA: '',
    loading: false
  };
  
  let panelWin = null, lastOpenTs = 0;
  let regPanelMap = new Map();

  // ===== HELPERS =====
  const el = s => document.querySelector(s);
  const tbody = el('#tbody');
  const pageInfo = el('#pageInfo');
  const toastEl = el('#toast');
  const toastIcon = toastEl.querySelector('i');
  const toastText = toastEl.querySelector('span');
  
  const escapeHtml = s => String(s??'').replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]));
  
  function toast(m, type = 'success') {
    toastText.textContent = m;
    toastIcon.className = `fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}`;
    toastEl.className = `toast ${type}`;
    toastEl.classList.add('show');
    setTimeout(() => toastEl.classList.remove('show'), 3000);
  }
  
  function num(x) { 
    const n = parseFloat(String(x||'').replace(/[^\d.]/g,'')) || 0; 
    return n.toFixed(2); 
  }

  function formatDateDDMMYYYY_HHMM(v) {
    if(!v) return '';
    let d; 
    if(v instanceof Date) d = v; 
    else { 
      const s = String(v); 
      d = /^\d{4}-\d{2}-\d{2}$/.test(s) ? new Date(s+'T00:00:00') : new Date(s); 
      if(isNaN(d)) return escapeHtml(s); 
    }
    const pad = n => String(n).padStart(2, '0');
    return `${pad(d.getDate())}/${pad(d.getMonth()+1)}/${d.getFullYear()} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
  }

  const toDigits = s => String(s||'').replace(/[^\d]/g,'');
  
  function buildWAUrl(phone, text) { 
    const p = toDigits(phone); 
    const q = encodeURIComponent(text||''); 
    if(!p) return ''; 
    return `https://web.whatsapp.com/send?phone=${p}${q ? `&text=${q}` : ''}`; 
  }

  const waSVG = `<svg class="icon" viewBox="0 0 32 32" aria-hidden="true" focusable="false"><circle cx="16" cy="16" r="16" fill="#25D366"/><path fill="#fff" d="M21.6 17.4c-.2-.1-1.2-.6-1.4-.7s-.3-.1-.5.1-.5.6-.6.7-.2.2-.4.1c-.2-.1-.8-.3-1.5-1-.6-.5-1-.9-1.1-1.1-.1-.2 0-.3.1-.4.1-.1.2-.3.3-.4.1-.1.1-.2.2-.3.1-.1 0-.3 0-.4s-.5-1.3-.7-1.8c-.2-.5-.4-.4-.5-.4h-.4c-.1 0 -.4.1 -.6.3 -.2.2 -.8.7 -.8 1.8s.9 2 1 2.2c.1.2 1.7 2.3 3.9 3.3.6.2 1 .4 1.3.5.5.2 1.1.2 1.5.1.4-.1 1.3-.6 1.5-1.1.2-.5.2-1 .1-1.1s-.2-.1-.4-.2zM16 6.1c-4.5 0-8.1 3.5-8.1 7.9 0 1.6.5 3.1 1.4 4.3l-1 3.6 3.7-1c1.2.7 2.7 1.1 4.3 1.1 4.5 0 8.1-3.5 8.1-7.9S20.5 6.1 16 6.1z"/></svg>`;

  // ===== Single Window reuse =====
  function openOrReusePanel(url) {
    if(!url) return;
    const now = Date.now(); 
    if(now - lastOpenTs < 250) return; 
    lastOpenTs = now;
    
    try {
      if(panelWin && !panelWin.closed) {
        try { 
          const current = panelWin.location && String(panelWin.location.href); 
          if(current === String(url)) { 
            panelWin.focus(); 
            return; 
          } 
        } catch(e) {}
        panelWin.location.href = url; 
        panelWin.focus(); 
        return;
      }
    } catch(e) {}
    
    const sw = window.screen.availWidth, sh = window.screen.availHeight;
    const w = Math.max(520, Math.round(sw * 0.34)), h = Math.max(650, sh);
    const left = Math.max(0, sw - w), top = 0;
    const features = ['popup=yes', 'toolbar=no', 'location=no', 'status=no', 'menubar=no', 'scrollbars=yes', 'resizable=yes', `width=${w}`, `height=${h}`, `left=${left}`, `top=${top}`].join(',');
    
    panelWin = window.open(url, 'panel_claim_window', features);
    if(!panelWin) { 
      alert('Sila benarkan pop-up untuk domain ini.'); 
      window.open(url, 'panel_claim_window'); 
      return; 
    }
    panelWin.focus();
  }

  // ===== REG PANEL MAP =====
  async function buildRegPanelMap() {
    regPanelMap.clear();
    try {
      const res = await fetch(`${API_BASE}?action=listregpanel`);
      const json = await res.json();
      if(json.status !== 'ok') return;
      
      const items = (json.data && (json.data.items || json.data)) || [];
      for(const p of items) {
        const key = String(p.panel_name || '').toLowerCase().trim();
        regPanelMap.set(key, { 
          pic_name: p.pic_name || '', 
          pic_phone: p.pic_phone || '', 
          panel_link: p.panel_link || p.login_url || p.claim_url_template || '', 
          payment_terms_days: parseInt(p.payment_terms_days, 10) || null 
        });
      }
    } catch(e) { 
      console.warn('Gagal muat Reg Panel map', e); 
    }
  }
  
  async function populatePanelDropdown() {
    const select = el('#filterPanelSelect');
    select.innerHTML = '<option value="">Semua Panel</option>';
    const names = Array.from(regPanelMap.keys()).sort((a, b) => a.localeCompare(b, 'ms', {sensitivity: 'base'}));
    
    for(const name of names) { 
      const opt = document.createElement('option'); 
      opt.value = name; 
      opt.textContent = name.replace(/\b\w/g, c => c.toUpperCase()); 
      select.appendChild(opt); 
    }
  }

  // ===== SLA util =====
  function deriveSLA(record) {
    const terms = (() => {
      const key = String(record.jenis_panel || '').toLowerCase().trim();
      const rp = regPanelMap.get(key);
      return rp && rp.payment_terms_days ? rp.payment_terms_days : null;
    })();
    
    let due = record.sla_due_at ? new Date(record.sla_due_at) : null;
    if ((!due || isNaN(due)) && record.status_claim === 'Submitted' && terms) {
      const base = record.submitted_at ? new Date(record.submitted_at) : new Date();
      if(!isNaN(base)) { 
        due = new Date(base); 
        due.setDate(due.getDate() + terms); 
      }
    }
    
    if(!due || isNaN(due)) return { label: '', cls: '', dueText: '' };
    
    const today = new Date(); 
    today.setHours(0, 0, 0, 0);
    const dd = new Date(due); 
    dd.setHours(0, 0, 0, 0);
    
    let cls = 'on', label = 'On Track';
    if(dd.getTime() < today.getTime()) { 
      cls = 'over'; 
      label = 'Overdue'; 
    } else if(dd.getTime() === today.getTime()) { 
      cls = 'today'; 
      label = 'Due Today'; 
    }
    
    return { label, cls, dueText: formatDateDDMMYYYY_HHMM(due) };
  }

  // ===== LOAD RECORDS =====
  function setActiveTab(tab) {
    state.tab = tab;
    document.querySelectorAll('.tab').forEach(t => t.classList.toggle('active', t.dataset.tab === tab));
    
    const isReg = tab === 'regpanel';
    el('#recordsView').style.display = isReg ? 'none' : '';
    el('#regPanelView').style.display = isReg ? '' : 'none';
    el('#searchBar').style.display = isReg ? 'none' : '';
    el('#statsContainer').style.display = isReg ? 'none' : '';
    
    if(isReg) { 
      loadRegPanel(); 
    } else { 
      state.page = 1; 
      load(); 
    }
  }

  async function load() {
    if(state.loading) return;
    state.loading = true;
    
    // Show loading state
    tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px"><i class="fas fa-spinner fa-spin" style="font-size:24px;color:var(--muted)"></i><div style="margin-top:10px">Memuat data...</div></td></tr>`;
    
    if(regPanelMap.size === 0) { 
      await buildRegPanelMap(); 
      await populatePanelDropdown(); 
    }
    
    const url = `${API_BASE}?action=listrecords&statusTab=${encodeURIComponent(state.tab)}&page=${state.page}&pageSize=${state.pageSize}&q=${encodeURIComponent(state.q)}`;
    
    try {
      const res = await fetch(url); 
      const json = await res.json();
      if(json.status !== 'ok') throw new Error(json.message || 'Gagal memuat data');
      
      const {total, items} = json.data;

      let filtered = items.slice();
      if(state.filterPanelSelect) { 
        const key = state.filterPanelSelect.toLowerCase(); 
        filtered = filtered.filter(r => String(r.jenis_panel || '').toLowerCase() === key); 
      }
      
      if(state.filterPanelText) { 
        const t = state.filterPanelText.toLowerCase(); 
        filtered = filtered.filter(r => String(r.jenis_panel || '').toLowerCase().includes(t)); 
      }
      
      if(state.tab === 'submitted' && state.filterSLA) { 
        filtered = filtered.filter(r => deriveSLA(r).cls === state.filterSLA); 
      }

      const sorted = sortItems(filtered);
      renderTable(sorted);
      updateBadgesApprox(sorted);
      updateStats(sorted);
      
    } catch(e) { 
      console.error(e); 
      toast('Ralat memuat data', 'error'); 
      tbody.innerHTML = `<tr><td colspan="9" style="text-align:center;padding:40px;color:var(--bad)"><i class="fas fa-exclamation-triangle"></i><div style="margin-top:10px">Gagal memuat data</div></td></tr>`;
    } finally {
      state.loading = false;
    }
  }

  function parseDate(v) { 
    if(!v) return null; 
    if(v instanceof Date) return v; 
    const s = String(v); 
    if(/^\d{4}-\d{2}-\d{2}$/.test(s)) return new Date(s + 'T00:00:00'); 
    const d = new Date(s); 
    return isNaN(d) ? null : d; 
  }
  
  function sortItems(items) {
    const m = state.sort;
    if(m === 'panel_az' || m === 'panel_za') { 
      items.sort((a, b) => String(a.jenis_panel || '').localeCompare(String(b.jenis_panel || ''), 'ms', {sensitivity: 'base'})); 
      if(m === 'panel_za') items.reverse(); 
      return items; 
    }
    
    if(m === 'nama_az' || m === 'nama_za') { 
      items.sort((a, b) => String(a.nama_pesakit || '').localeCompare(String(b.nama_pesakit || ''), 'ms', {sensitivity: 'base'})); 
      if(m === 'nama_za') items.reverse(); 
      return items; 
    }
    
    items.sort((a, b) => { 
      const da = parseDate(a.tarikh_hadir), db = parseDate(b.tarikh_hadir); 
      const ta = da ? da.getTime() : 0, tb = db ? db.getTime() : 0; 
      return tb - ta; 
    });
    
    if(m === 'tarikh_asc') items.reverse(); 
    return items;
  }

  function renderTable(items) {
    if(pageInfo) pageInfo.textContent = `Halaman ${state.page} • ${items.length} rekod`;
    
    if(items.length === 0) {
      tbody.innerHTML = `<tr><td colspan="9" class="empty-state"><i class="fas fa-inbox"></i><div>Tiada rekod ditemui</div></td></tr>`;
      return;
    }
    
    tbody.innerHTML = items.map(r => renderRow(r)).join('');
    items.forEach(r => wireRow(r));
  }

  function renderRow(r) {
    const status = (r.status_claim || 'Not Started');
    const chipClass = status === 'Done' || status === 'Submitted' ? 'done' : (status === 'Rejected' ? 'rejected' : 'inprocess');

    const key = String(r.jenis_panel || '').toLowerCase().trim();
    const reg = regPanelMap.get(key);

    const waPatientURL = r.no_telefon ? buildWAUrl(r.no_telefon, `Assalamualaikum/Hi ${r.nama_pesakit || ''}`) : '';
    const waPatientIcon = waPatientURL ? `<a class="wa" href="javascript:void(0)" aria-label="WhatsApp Pesakit" title="WhatsApp Pesakit" onclick="openOrReusePanel('${waPatientURL.replace(/'/g, "%27")}')">${waSVG}</a>` : '';

    const waPICURL = (reg && reg.pic_phone) ? buildWAUrl(reg.pic_phone, `Hi ${reg.pic_name || 'PIC'}, rujukan tuntutan: ${r.record_id || ''}`) : '';
    const waPICIcon = waPICURL ? `<a class="wa" href="javascript:void(0)" aria-label="WhatsApp PIC Panel" title="WhatsApp PIC Panel" onclick="openOrReusePanel('${waPICURL.replace(/'/g, "%27")}')">${waSVG}</a>` : '';

    const price = `<div class="price">Consult RM${num(r.harga_consultation)} · Ubat RM${num(r.harga_ubat)} · Prosedur RM${num(r.harga_prosedur)}<br><b>Jumlah RM${num(r.harga_jumlah)}</b></div>`;

    const sla = deriveSLA(r);
    const slaBadge = sla.cls ? `<span class="sla ${sla.cls}" title="Due: ${sla.dueText}">${sla.label}</span>` : '';

    const submittedActions = state.tab === 'submitted'
      ? `<button class="secondary btn-pending" title="Masih menunggu"><i class="fas fa-clock"></i></button>
         <button class="btn-success btn-done" title="Tanda Done"><i class="fas fa-check"></i></button>
         <button class="btn-danger btn-rejected" title="Tanda Rejected"><i class="fas fa-times"></i></button>`
      : '';

    return `<tr data-id="${escapeHtml(r.record_id)}">
      <td><strong>${escapeHtml(r.nama_pesakit || '')}</strong></td>
      <td>${escapeHtml(r.no_ic || '')}</td>
      <td><div style="display:flex;align-items:center;gap:8px"><span>${escapeHtml(r.no_telefon || '')}</span>${waPatientIcon || ''}</div></td>
      <td>${formatDateDDMMYYYY_HHMM(r.tarikh_hadir)}</td>
      <td>
        <div><b>${escapeHtml(r.jenis_panel || '')}</b>${slaBadge}</div>
        ${reg ? `<div class="price" style="margin-top:4px">${escapeHtml(reg.pic_name || '-')}<br><div style="display:flex;align-items:center;gap:8px"><small>${escapeHtml(reg.pic_phone || '')}</small>${waPICIcon || ''}</div></div>` : ''}
      </td>
      <td>${price}</td>
      <td>${escapeHtml(r.jenis_ubat || '')}</td>
      <td><span class="chip ${chipClass}">${escapeHtml(status)}</span></td>
      <td class="actions">
        <button class="secondary btn-open" title="Buka laman panel"><i class="fas fa-external-link-alt"></i></button>
        ${state.tab === 'inprocess'
          ? `<button class="btn-success btn-submit" title="Hantar ke Submitted"><i class="fas fa-paper-plane"></i></button>`
          : submittedActions
        }
        <button class="btn-warning btn-edit" title="Edit rekod"><i class="fas fa-edit"></i></button>
        <button class="btn-danger btn-delete" title="Padam rekod"><i class="fas fa-trash"></i></button>
      </td>
    </tr>`;
  }

  function wireRow(r) {
    const tr = tbody.querySelector(`tr[data-id="${CSS.escape(String(r.record_id))}"]`);
    if(!tr) return;

    // OPEN
    tr.querySelector('.btn-open').addEventListener('click', () => {
      const url = r.panel_claim_url || (() => {
        const key = String(r.jenis_panel || '').toLowerCase().trim();
        const reg = regPanelMap.get(key);
        return reg && reg.panel_link ? reg.panel_link : '';
      })();
      
      if(!url) { 
        toast('URL panel tiada', 'error'); 
        return; 
      }
      
      openOrReusePanel(url);
    });

    // SUBMIT
    if (state.tab === 'inprocess') {
      tr.querySelector('.btn-submit')?.addEventListener('click', async () => {
        const ref = prompt('Masukkan Claim Ref/ID (jika ada):', r.claim_ref_id || '');
        if (ref === null) { 
          toast('Dibatalkan.', 'warning'); 
          return; 
        }
        
        await updateStatus(r.record_id, { status_claim: 'Submitted', claim_ref_id: ref });
      });
    } else if (state.tab === 'submitted') {
      tr.querySelector('.btn-pending')?.addEventListener('click', async () => { 
        await updateStatus(r.record_id, { status_claim: 'Submitted' }); 
      });
      
      tr.querySelector('.btn-done')?.addEventListener('click', async () => {
        const ref = prompt('Masukkan Claim Ref/ID (jika belum diisi):', r.claim_ref_id || '');
        if (ref === null) { 
          toast('Dibatalkan.', 'warning'); 
          return; 
        }
        
        await updateStatus(r.record_id, { status_claim: 'Done', claim_ref_id: ref });
      });
      
      tr.querySelector('.btn-rejected')?.addEventListener('click', async () => {
        const reason = prompt('Sebab Rejected (optional):', '');
        if (reason === null) { 
          toast('Dibatalkan.', 'warning'); 
          return; 
        }
        
        await updateStatus(r.record_id, { status_claim: 'Rejected', notes: reason || '' });
      });
    }

    // EDIT (prompt ringkas untuk field penting)
    tr.querySelector('.btn-edit').addEventListener('click', async () => {
      const fields = {};
      let v = prompt('Nama Pesakit (biar kosong untuk kekal):', r.nama_pesakit || ''); 
      if(v === null) return; 
      if(v !== '') fields.nama_pesakit = v;
      
      v = prompt('Jenis Panel (contoh: AIA):', r.jenis_panel || ''); 
      if(v === null) return; 
      if(v !== '') fields.jenis_panel = v;
      
      v = prompt('URL Panel / Claim:', r.panel_claim_url || ''); 
      if(v === null) return; 
      if(v !== '') fields.panel_claim_url = v;
      
      v = prompt('No. Telefon Pesakit:', r.no_telefon || ''); 
      if(v === null) return; 
      if(v !== '') fields.no_telefon = v;
      
      v = prompt('Jenis Ubat:', r.jenis_ubat || ''); 
      if(v === null) return; 
      if(v !== '') fields.jenis_ubat = v;
      
      v = prompt('Harga Consultation (RM):', r.harga_consultation || ''); 
      if(v === null) return; 
      if(v !== '') fields.harga_consultation = v;
      
      v = prompt('Harga Ubat (RM):', r.harga_ubat || ''); 
      if(v === null) return; 
      if(v !== '') fields.harga_ubat = v;
      
      v = prompt('Harga Prosedur (RM):', r.harga_prosedur || ''); 
      if(v === null) return; 
      if(v !== '') fields.harga_prosedur = v;
      
      v = prompt('Catatan Lawatan (visit notes):', r.visit_notes || ''); 
      if(v === null) return; 
      if(v !== '') fields.visit_notes = v;

      if(Object.keys(fields).length === 0) { 
        toast('Tiada perubahan.', 'warning'); 
        return; 
      }
      
      try {
        await postForm('updaterecordfields', { record_id: r.record_id, fields });
        toast('Rekod dikemas kini', 'success'); 
        await load();
      } catch(e) { 
        console.error(e); 
        toast('Gagal kemas rekod', 'error'); 
      }
    });

    // DELETE (soft delete)
    tr.querySelector('.btn-delete').addEventListener('click', async () => {
      if(!confirm(`Padam rekod untuk ${r.nama_pesakit || ''}?`)) return;
      
      try { 
        await postForm('deleterecord', { record_id: r.record_id }); 
        toast('Rekod dipadam', 'success'); 
        await load(); 
      } catch(e) { 
        console.error(e); 
        toast('Gagal padam rekod', 'error'); 
      }
    });
  }

  // ===== POST util (x-www-form-urlencoded) =====
  async function postForm(action, obj) {
    const body = new URLSearchParams(); 
    body.set('payload', JSON.stringify(obj || {}));
    
    const res = await fetch(`${API_BASE}?action=${encodeURIComponent(action)}`, { method: 'POST', body });
    const json = await res.json().catch(() => null);
    
    if(!json || json.status !== 'ok') throw new Error((json && json.message) || 'Request gagal');
    return json;
  }
  
  async function updateStatus(record_id, payload) {
    try {
      // UI optimistik
      const tr = tbody.querySelector(`tr[data-id="${CSS.escape(String(record_id))}"]`);
      if(tr && payload.status_claim) {
        const chip = tr.querySelector('.chip');
        chip.textContent = payload.status_claim;
        chip.className = 'chip ' + (payload.status_claim === 'Rejected' ? 'rejected' : (payload.status_claim === 'Done' || payload.status_claim === 'Submitted' ? 'done' : 'inprocess'));
      }
      
      await postForm('updateclaimstatus', { record_id, ...payload });
      toast('Status dikemas kini', 'success'); 
      await load();
    } catch(e) { 
      toast(e.message || 'Gagal kemas status', 'error'); 
      await load(); 
    }
  }
  
  function updateBadgesApprox(items) {
    const count = { inprocess: 0, submitted: 0, done: 0, rejected: 0 };
    items.forEach(r => { 
      const s = (r.status_claim || 'Not Started'); 
      if(s === 'Done') count.done++; 
      else if(s === 'Rejected') count.rejected++; 
      else if(s === 'Submitted') count.submitted++; 
      else count.inprocess++; 
    });
    
    el('#badge-inprocess').textContent = String(count.inprocess);
    el('#badge-submitted').textContent = String(count.submitted);
    el('#badge-done').textContent = String(count.done);
    el('#badge-rejected').textContent = String(count.rejected);
  }
  
  function updateStats(items) {
    const count = { inprocess: 0, submitted: 0, done: 0, rejected: 0 };
    items.forEach(r => { 
      const s = (r.status_claim || 'Not Started'); 
      if(s === 'Done') count.done++; 
      else if(s === 'Rejected') count.rejected++; 
      else if(s === 'Submitted') count.submitted++; 
      else count.inprocess++; 
    });
    
    el('#stat-inprocess').textContent = String(count.inprocess);
    el('#stat-submitted').textContent = String(count.submitted);
    el('#stat-done').textContent = String(count.done);
    el('#stat-rejected').textContent = String(count.rejected);
  }

  // ===== Reg Panel view (LIST + SAVE/CLEAR + EDIT/DELETE) =====
  async function loadRegPanel() {
    try {
      const res = await fetch(`${API_BASE}?action=listregpanel`);
      const json = await res.json();
      if(json.status !== 'ok') throw new Error(json.message || 'Gagal memuat Reg Panel');
      
      const items = (json.data && (json.data.items || json.data)) || [];
      document.getElementById('rp_tbody').innerHTML = items.map(p => {
        const href = p.pic_phone ? buildWAUrl(p.pic_phone, `Hi ${p.pic_name || 'PIC'} — pesanan dari klinik`) : '';
        const waBtn = href ? `<a class="wa" href="javascript:void(0)" onclick="openOrReusePanel('${href.replace(/'/g, "%27")}')" title="WhatsApp PIC">${waSVG}</a>` : '';
        const terms = parseInt(p.payment_terms_days, 10) || '';
        const link = escapeHtml(p.panel_link || p.login_url || p.claim_url_template || '#');
        
        return `<tr data-panel="${escapeHtml(p.panel_name || '')}">
          <td><strong>${escapeHtml(p.panel_name || '')}</strong></td>
          <td><a href="${link}" target="_blank" rel="noopener">Buka</a></td>
          <td>${escapeHtml(p.pic_name || '')}<br><small>${escapeHtml(p.pic_phone || '')}</small></td>
          <td>${escapeHtml(terms)}</td>
          <td>${waBtn}</td>
          <td class="actions">
            <button class="btn-warning btn-rp-edit"><i class="fas fa-edit"></i></button>
            <button class="btn-danger btn-rp-del"><i class="fas fa-trash"></i></button>
          </td>
        </tr>`;
      }).join('');
      
      await buildRegPanelMap(); 
      await populatePanelDropdown();

      // Wire row actions
      document.querySelectorAll('#rp_tbody tr').forEach(tr => {
        const name = tr.getAttribute('data-panel');
        tr.querySelector('.btn-rp-edit').addEventListener('click', () => editRegPanel(name));
        tr.querySelector('.btn-rp-del').addEventListener('click', () => deleteRegPanel(name));
      });
    } catch(e) { 
      console.error(e); 
      toast('Ralat memuat Reg Panel', 'error'); 
    }
  }

  async function saveRegPanel() {
    const name = el('#rp_name').value.trim();
    const link = el('#rp_link').value.trim();
    const picName = el('#rp_pic_name').value.trim();
    const picPhone = el('#rp_pic_phone').value.trim();
    const termsDays = parseInt(el('#rp_terms_days').value, 10);
    const notes = el('#rp_notes').value.trim();

    if(!name || !link || !Number.isFinite(termsDays) || termsDays <= 0) { 
      toast('Isi Nama Panel, Link, dan Tempoh (hari).', 'error'); 
      return; 
    }
    
    try {
      await postForm('updateregpanel', { panel_name: name, panel_link: link, pic_name: picName, pic_phone: picPhone, payment_terms_days: termsDays, notes });
      toast('Panel disimpan.', 'success'); 
      clearRegPanelForm(); 
      await loadRegPanel();
    } catch(e) { 
      console.error(e); 
      toast('Gagal simpan panel', 'error'); 
    }
  }
  
  function clearRegPanelForm() { 
    ['#rp_name', '#rp_link', '#rp_pic_name', '#rp_pic_phone', '#rp_terms_days', '#rp_notes'].forEach(id => el(id).value = ''); 
  }

  async function editRegPanel(name) {
    if(!name) return;
    
    // prefill from map if exists
    const key = String(name).toLowerCase();
    const v = regPanelMap.get(key) || {};
    
    const newName = prompt('Nama Panel', name); 
    if(newName === null) return;
    
    const link = prompt('Link Panel (URL)', v.panel_link || ''); 
    if(link === null) return;
    
    const picn = prompt('Nama PIC', v.pic_name || ''); 
    if(picn === null) return;
    
    const picp = prompt('No. Telefon PIC', v.pic_phone || ''); 
    if(picp === null) return;
    
    const terms = prompt('Tempoh (hari)', v.payment_terms_days || ''); 
    if(terms === null) return;

    try {
      await postForm('updateregpanel', { panel_name: newName || name, panel_link: link || '', pic_name: picn || '', pic_phone: picp || '', payment_terms_days: parseInt(terms, 10) || '' });
      toast('Panel dikemas kini', 'success'); 
      await loadRegPanel();
    } catch(e) { 
      console.error(e); 
      toast('Gagal kemas panel', 'error'); 
    }
  }
  
  async function deleteRegPanel(name) {
    if(!name) return;
    
    if(!confirm(`Padam panel "${name}"?`)) return;
    
    try { 
      await postForm('deleteregpanel', { panel_name: name }); 
      toast('Panel dipadam', 'success'); 
      await loadRegPanel(); 
    } catch(e) { 
      console.error(e); 
      toast('Gagal padam panel', 'error'); 
    }
  }

  // ===== Quick Actions =====
  function setupQuickActions() {
    el('#quickNewClaim').addEventListener('click', () => {
      toast('Fungsi Tuntutan Baru akan datang', 'info');
    });
    
    el('#quickExport').addEventListener('click', () => {
      toast('Fungsi Eksport Data akan datang', 'info');
    });
    
    el('#quickReports').addEventListener('click', () => {
      toast('Fungsi Laporan akan datang', 'info');
    });
  }

  // ===== Events =====
  document.querySelectorAll('.tab').forEach(t => t.addEventListener('click', () => setActiveTab(t.dataset.tab)));
  
  el('#search').addEventListener('input', e => { 
    state.q = e.target.value.trim(); 
    state.page = 1; 
    load(); 
  });
  
  el('#filterPanelSelect').addEventListener('change', e => { 
    state.filterPanelSelect = e.target.value; 
    state.page = 1; 
    load(); 
  });
  
  el('#filterPanelText').addEventListener('input', e => { 
    state.filterPanelText = e.target.value.trim(); 
    state.page = 1; 
    load(); 
  });
  
  el('#filterSLA').addEventListener('change', e => { 
    state.filterSLA = e.target.value; 
    state.page = 1; 
    load(); 
  });
  
  el('#sort').addEventListener('change', e => { 
    state.sort = e.target.value; 
    state.page = 1; 
    load(); 
  });
  
  el('#pageSize').addEventListener('change', e => { 
    state.pageSize = parseInt(e.target.value, 10) || 50; 
    state.page = 1; 
    load(); 
  });
  
  el('#refresh').addEventListener('click', load);
  el('#prev').addEventListener('click', () => { if(state.page > 1) { state.page--; load(); } });
  el('#next').addEventListener('click', () => { state.page++; load(); });

  // Reg Panel buttons
  document.addEventListener('click', (ev) => {
    if(ev.target && ev.target.id === 'rp_save') { saveRegPanel(); }
    if(ev.target && ev.target.id === 'rp_clear') { clearRegPanelForm(); toast('Bersih.', 'info'); }
  });

  // INIT
  setupQuickActions();
  setActiveTab('inprocess');
  </script>
</body>
</html>
